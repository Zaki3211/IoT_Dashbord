<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard IoT Akuaponik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-blue: #1a73e8;
            --aqua-green: #00c9b7;
            --water-blue: #4fc3f7;
            --plant-green: #81c784;
            --fish-orange: #ff8a65;
            --warning-red: #ff5252;
            --safe-green: #4caf50;
            --control-blue: #2196f3;
            --control-red: #f44336;
            --auto-color: #4caf50;
            --manual-color: #ff9800;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-top: 20px;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Responsive container */
        .container {
            padding-left: 15px;
            padding-right: 15px;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            body {
                padding-top: 10px;
                padding-bottom: 80px;
            }
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
        }

        /* Header Responsive */
        .dashboard-header {
            background: linear-gradient(90deg, var(--primary-blue), var(--aqua-green));
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(26, 115, 232, 0.2);
            animation: slideInDown 0.8s ease-out;
            width: 100%;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 12px;
            }
            .dashboard-header h1 {
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            .dashboard-header .lead {
                font-size: 0.8rem !important;
                margin-bottom: 0.5rem !important;
            }
        }

        /* Status Indicators - Simplified for mobile */
        .status-container {
            position: relative;
            z-index: 1000;
            margin-bottom: 10px;
        }

        @media (min-width: 769px) {
            .status-container {
                position: fixed;
                top: 20px;
            }
            .esp-status-container {
                left: 20px;
                width: 280px;
            }
            .mode-indicator-container {
                right: 20px;
            }
        }

        @media (max-width: 768px) {
            .status-container {
                width: 100%;
                margin-bottom: 8px;
            }
            .esp-status-container {
                order: 1;
            }
            .mode-indicator-container {
                order: 2;
                margin-top: 5px;
            }
        }

        /* ESP Status Card */
        .esp-status-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #6c757d;
            transition: all 0.3s;
            width: 100%;
        }

        .esp-status-card.online {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f0fff4, #e6ffed);
        }

        .esp-status-card.offline {
            border-left: 4px solid #dc3545;
            background: linear-gradient(135deg, #fff5f5, #ffe5e5);
            animation: pulseWarning 2s infinite;
        }

        .esp-status-indicator {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .esp-status-indicator.online {
            color: #28a745;
            animation: pulse 2s infinite;
        }

        .esp-status-indicator.offline {
            color: #dc3545;
        }

        /* Mode Indicator */
        .mode-indicator {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            text-transform: uppercase;
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        @media (min-width: 769px) {
            .mode-indicator {
                width: auto;
                animation: pulse 2s infinite;
            }
        }

        .mode-auto {
            background: linear-gradient(90deg, var(--auto-color), #66bb6a);
            color: white;
        }

        .mode-manual {
            background: linear-gradient(90deg, var(--manual-color), #ffb74d);
            color: white;
        }

        @keyframes pulseWarning {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        /* ESP Offline Overlay - Fixed for mobile */
        .esp-offline-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .esp-offline-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .esp-offline-message {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s ease-out;
        }

        @media (max-width: 768px) {
            .esp-offline-message {
                padding: 1.5rem;
                margin: 0;
            }
            .esp-offline-message h3 {
                font-size: 1.3rem;
            }
            .esp-offline-message p {
                font-size: 0.9rem;
            }
        }

        /* Navigation Tabs Responsive */
        .nav-tabs-custom {
            border-bottom: none;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px;
        }

        .nav-tabs-custom::-webkit-scrollbar {
            display: none;
        }

        .nav-tabs-custom .nav-link {
            color: #666;
            border: none;
            border-radius: 50px;
            padding: 0.6rem 1.5rem;
            margin: 0 5px;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: inline-block;
        }

        .nav-tabs-custom .nav-link i {
            margin-right: 6px;
            font-size: 1rem;
        }

        .nav-tabs-custom .nav-link.active {
            background: linear-gradient(90deg, var(--primary-blue), var(--aqua-green));
            color: white;
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
            border: none;
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .nav-tabs-custom {
                margin-bottom: 1rem;
            }
            .nav-tabs-custom .nav-link {
                padding: 0.5rem 1.2rem;
                font-size: 0.85rem;
                min-width: 140px;
                text-align: center;
            }
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
            width: 100%;
        }

        .content-section.active {
            display: block;
        }

        /* Riwayat Pakan Card */
        .feed-history-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid var(--aqua-green);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .feed-history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .feed-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .feed-history-title {
            font-weight: 600;
            color: var(--primary-blue);
            margin: 0;
        }

        .feed-history-content {
            padding: 8px 0;
        }

        .feed-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .feed-history-item:last-child {
            border-bottom: none;
        }

        .feed-history-label {
            font-size: 0.85rem;
            color: #666;
            min-width: 120px;
        }

        .feed-history-value {
            font-weight: 600;
            color: var(--primary-blue);
            text-align: right;
        }

        .feed-history-value.success {
            color: var(--safe-green);
        }

        .feed-history-value.warning {
            color: var(--manual-color);
        }

        .feed-history-timestamp {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
            text-align: right;
            margin-top: 5px;
        }

        .feed-history-empty {
            text-align: center;
            color: #999;
            padding: 15px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .feed-history-card {
                padding: 12px;
                margin-top: 10px;
            }
            
            .feed-history-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 6px 0;
            }
            
            .feed-history-label {
                min-width: auto;
                font-size: 0.8rem;
                margin-bottom: 2px;
            }
            
            .feed-history-value {
                text-align: left;
                font-size: 0.9rem;
            }
            
            .feed-history-timestamp {
                text-align: left;
                font-size: 0.75rem;
            }
        }

        /* Confirmation Modal */
        .modal-confirm {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9998;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content-confirm {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideInDown 0.3s ease-out;
            position: relative;
            z-index: 9999;
        }

        @media (max-width: 768px) {
            .modal-content-confirm {
                padding: 20px;
                max-width: 320px;
            }
        }

        /* === SERVO ACTIVE INDICATOR RESPONSIF (BARU) === */
        .servo-active-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            z-index: 2000;
            background: linear-gradient(135deg, 
                rgba(255, 152, 0, 0.95), 
                rgba(255, 87, 34, 0.95),
                rgba(255, 152, 0, 0.95));
            color: white;
            padding: 25px;
            border-radius: 20px;
            animation: servoAppear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            display: none;
            max-width: 400px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* Header servo */
        .servo-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .servo-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-top: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        /* Gear icon */
        .servo-gear {
            font-size: 3rem;
            display: inline-block;
            color: white;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
            animation: gearRotate 3s linear infinite;
        }

        /* Progress container */
        .servo-progress-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 25px;
        }

        .servo-progress-ring {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .servo-progress-ring-circle {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .servo-progress-ring-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 6;
            stroke-linecap: round;
        }

        .servo-progress-ring-fill {
            fill: none;
            stroke: #FFEB3B;
            stroke-width: 6;
            stroke-linecap: round;
            filter: drop-shadow(0 0 8px rgba(255, 235, 59, 0.6));
            transition: stroke-dashoffset 0.3s linear;
        }

        .servo-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .feeding-time {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            display: block;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            background: linear-gradient(to bottom, #FFF, #FFECB3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .servo-progress-text small {
            font-size: 0.9rem;
            opacity: 0.8;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Status text */
        .servo-status {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .servo-status-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .servo-status-subtext {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Particles */
        .servo-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
            border-radius: 20px;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(255, 235, 59, 0.8) 0%, rgba(255, 193, 7, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        /* Action button */
        .servo-action {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .servo-action .btn {
            padding: 8px 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }

        .servo-action .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Animations */
        @keyframes servoAppear {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
                filter: blur(10px);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
                filter: blur(0);
            }
        }

        @keyframes servoDisappear {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
                filter: blur(0);
            }
            100% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
                filter: blur(10px);
            }
        }

        @keyframes gearRotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes gearPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        @keyframes particleFloat {
            0% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) rotate(var(--r));
                opacity: 0;
            }
        }

        @keyframes pulseRing {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 235, 59, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(255, 235, 59, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 235, 59, 0);
            }
        }

        /* Feed card active state */
        .feeding-active {
            animation: feedContainerPulse 2s infinite !important;
            position: relative;
            z-index: 100;
        }

        @keyframes feedContainerPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4);
            }
            50% {
                box-shadow: 0 0 20px 10px rgba(255, 152, 0, 0.2);
            }
        }

        /* ========== RESPONSIVE STYLES ========== */

        /* Tablet */
        @media (max-width: 992px) {
            .servo-progress-container {
                width: 180px;
                height: 180px;
            }
            
            .feeding-time {
                font-size: 3rem;
            }
            
            .servo-gear {
                font-size: 2.8rem;
            }
            
            .servo-title {
                font-size: 1.2rem;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .servo-active-indicator {
                padding: 20px 15px;
                max-width: 320px;
                transform: translate(-50%, -50%) scale(0.95);
            }
            
            .servo-progress-container {
                width: 150px;
                height: 150px;
                margin-bottom: 20px;
            }
            
            .servo-gear {
                font-size: 2.5rem;
                animation: gearPulse 2s infinite;
            }
            
            .servo-title {
                font-size: 1.1rem;
                margin-top: 8px;
            }
            
            .feeding-time {
                font-size: 2.8rem;
            }
            
            .servo-status {
                padding: 12px;
                margin: 15px 0;
            }
            
            .servo-status-text {
                font-size: 1rem;
            }
            
            .servo-status-subtext {
                font-size: 0.85rem;
            }
            
            .servo-action .btn {
                padding: 6px 16px;
                font-size: 0.9rem;
            }
        }

        /* Small mobile */
        @media (max-width: 480px) {
            .servo-active-indicator {
                padding: 15px;
                max-width: 280px;
            }
            
            .servo-progress-container {
                width: 120px;
                height: 120px;
            }
            
            .servo-gear {
                font-size: 2.2rem;
            }
            
            .feeding-time {
                font-size: 2.2rem;
            }
            
            .servo-progress-text small {
                font-size: 0.8rem;
            }
            
            .servo-title {
                font-size: 1rem;
            }
            
            .servo-status-text {
                font-size: 0.95rem;
            }
        }

        /* Card Responsive */
        .card {
            border: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 1.2rem;
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out;
            width: 100%;
        }

        @media (max-width: 768px) {
            .card {
                border-radius: 10px;
                margin-bottom: 1rem;
                box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            }
            .card-header {
                padding: 0.8rem 1rem !important;
            }
            .card-header h4 {
                font-size: 1rem;
                margin-bottom: 0;
            }
            .card-body {
                padding: 1rem;
            }
        }

        .card-header {
            background: linear-gradient(90deg, var(--primary-blue), var(--aqua-green));
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem 1.2rem;
        }

        /* Water Tank Animation Responsive */
        .water-tank-container {
            position: relative;
            width: 100%;
            height: 250px;
            margin: 0 auto 1rem;
        }

        @media (max-width: 768px) {
            .water-tank-container {
                height: 180px;
                margin-bottom: 0.8rem;
            }
        }

        .water-tank {
            position: absolute;
            width: 180px;
            height: 200px;
            left: 50%;
            transform: translateX(-50%);
            border: 3px solid var(--water-blue);
            border-radius: 10px;
            background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .water-tank {
                width: 140px;
                height: 160px;
            }
        }

        .water-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, var(--water-blue), #29b6f6);
            transition: height 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 0 0 7px 7px;
        }

        .fish {
            position: absolute;
            width: 25px;
            height: 12px;
            background: var(--fish-orange);
            border-radius: 50%;
            animation: swim 8s infinite linear;
        }

        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: bubbleRise 4s infinite linear;
        }

        /* Feed Container Responsive */
        .feed-container {
            position: relative;
            width: 100px;
            height: 180px;
            margin: 0 auto 1rem;
            border: 3px solid #8d6e63;
            border-radius: 10px;
            background: linear-gradient(to bottom, #efebe9, #d7ccc8);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .feed-container {
                width: 90px;
                height: 150px;
                margin-bottom: 0.8rem;
            }
        }

        .feed-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #8d6e63, #a1887f);
            transition: height 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 0 0 7px 7px;
        }

        /* Sensor Cards Responsive */
        .sensor-card {
            border-left: 4px solid;
            padding: 12px;
            border-radius: 8px;
            background: white;
            transition: all 0.3s;
            height: 100%;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            .sensor-card {
                padding: 10px;
                margin-bottom: 10px;
            }
            .sensor-card .value-display {
                font-size: 1.6rem !important;
            }
            .sensor-card i {
                font-size: 1.8rem !important;
            }
            .sensor-card h6 {
                font-size: 0.8rem;
            }
        }

        .sensor-card.ph { border-color: #9c27b0; }
        .sensor-card.tds { border-color: #2196f3; }
        .sensor-card.turbidity { border-color: #ff9800; }

        .value-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-blue);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        .value-unit {
            font-size: 1rem;
            color: #666;
            margin-left: 3px;
        }

        @media (max-width: 768px) {
            .value-display {
                font-size: 1.6rem;
            }
            .value-unit {
                font-size: 0.85rem;
            }
        }

        /* Control Cards Responsive */
        .control-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            height: 100%;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .control-card {
                padding: 12px;
                margin-bottom: 12px;
            }
            .control-card h5 {
                font-size: 0.95rem;
                margin-bottom: 5px;
            }
            .control-icon {
                font-size: 2rem !important;
                margin-bottom: 10px !important;
            }
        }

        .control-status {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: statusPulse 2s infinite;
        }

        .status-on { 
            background: var(--safe-green); 
            animation: statusPulse 2s infinite;
        }
        .status-off { 
            background: var(--warning-red); 
            animation: none;
        }
        .status-loading { 
            background: #ff9800; 
            animation: pulse 1s infinite;
        }

        .control-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: var(--primary-blue);
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        @media (max-width: 768px) {
            .control-buttons {
                gap: 6px;
            }
        }

        .control-btn {
            flex: 1;
            padding: 8px 4px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 0.85rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .control-btn {
                padding: 6px 3px;
                font-size: 0.8rem;
                min-height: 36px;
            }
        }

        .btn-on {
            background: linear-gradient(135deg, var(--safe-green), #66bb6a);
            color: white;
        }

        .btn-off {
            background: linear-gradient(135deg, var(--warning-red), #ef5350);
            color: white;
        }

        .control-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Feed Management Card Responsive */
        .feed-management-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            height: 100%;
        }

        @media (max-width: 768px) {
            .feed-management-card {
                padding: 15px;
            }
        }

        .slider-container {
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .slider-container {
                padding: 12px;
                margin: 12px 0;
            }
            .slider-container h6 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding: 0 5px;
        }

        .slider-label {
            font-weight: 600;
            color: #666;
            padding: 4px 8px;
            border-radius: 15px;
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .slider-label {
                font-size: 0.75rem;
                padding: 3px 6px;
            }
        }

        .slider-label.active {
            background: var(--aqua-green);
            color: white;
            transform: scale(1.05);
        }

        /* Custom Slider Responsive */
        .custom-slider {
            appearance: none;
            -moz-appearance: none;
            -webkit-appearance: none;
            width: 100%;
            height: 16px;
            border-radius: 8px;
            background: linear-gradient(to right, #81c784, #4caf50, #388e3c);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }

        @media (max-width: 768px) {
            .custom-slider {
                height: 14px;
            }
        }

        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--aqua-green);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .custom-slider::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
            }
        }

        /* Calibration Styles Responsive - FIXED INPUT WIDTH */
        .calibration-step {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--aqua-green);
        }

        @media (max-width: 768px) {
            .calibration-step {
                padding: 12px;
                margin-bottom: 12px;
            }
            .calibration-step h5 {
                font-size: 1rem;
            }
            .calibration-step p {
                font-size: 0.85rem;
                margin-bottom: 10px;
            }
        }

        .calibration-step-number {
            display: inline-block;
            width: 35px;
            height: 35px;
            background: var(--aqua-green);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            margin-right: 12px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .calibration-step-number {
                width: 32px;
                height: 32px;
                line-height: 32px;
                font-size: 0.85rem;
                margin-right: 10px;
            }
        }

        /* FIXED INPUT GROUP FOR MOBILE */
        .input-group {
            flex-wrap: nowrap;
        }

        @media (max-width: 768px) {
            .input-group {
                flex-wrap: wrap;
            }
            .input-group .form-control {
                min-width: 0;
                flex: 1;
                font-size: 16px !important;
            }
            .input-group-text {
                font-size: 0.85rem;
                padding: 8px 12px;
                min-width: 80px;
            }
            .input-group .btn {
                margin-top: 8px;
                width: 100%;
                order: 3;
            }
        }

        /* Animations */
        @keyframes swim {
            0% { transform: translateX(-25px) rotateY(0); }
            25% { transform: translateX(calc(50% - 12px)) rotateY(0); }
            26% { transform: translateX(calc(50% - 12px)) rotateY(180deg); }
            75% { transform: translateX(calc(100% - 12px)) rotateY(180deg); }
            76% { transform: translateX(calc(100% - 12px)) rotateY(0); }
            100% { transform: translateX(-25px) rotateY(0); }
        }

        @keyframes bubbleRise {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-150px) scale(1.2);
                opacity: 0;
            }
        }

        @keyframes statusPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(76, 175, 80, 0);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Notification Container */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
            max-width: 350px;
        }

        @media (max-width: 768px) {
            .notification {
                left: 10px;
                right: 10px;
                bottom: 10px;
                max-width: 100%;
            }
            .notification .alert {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            /* Adjust grid system */
            .row {
                margin-left: -6px;
                margin-right: -6px;
            }
            
            .col, .col-auto, .col-1, .col-2, .col-3, .col-4, .col-5, .col-6,
            .col-7, .col-8, .col-9, .col-10, .col-11, .col-12,
            .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6,
            .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12,
            .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6,
            .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12 {
                padding-left: 6px;
                padding-right: 6px;
            }
            
            /* Hide non-essential elements on mobile */
            .plant-growth {
                display: none;
            }
            
            .water-drop {
                display: none;
            }
            
            /* Adjust button sizes for touch */
            button, .btn, .control-btn, .nav-link {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Prevent text selection on buttons */
            button, .btn {
                user-select: none;
                -webkit-user-select: none;
            }
            
            /* Improve form input appearance */
            input, select, textarea {
                font-size: 16px !important;
            }
            
            /* Fix for overflow issues */
            .card-body {
                overflow: hidden;
            }
        }

        /* Desktop Optimizations */
        @media (min-width: 769px) {
            .container {
                max-width: 1200px;
            }
        }

        /* Fix for iOS Safari */
        @supports (-webkit-touch-callout: none) {
            .servo-active-indicator {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
        }
    </style>
</head>
<body>
    <!-- ESP Offline Overlay -->
    <div class="esp-offline-overlay" id="esp-offline-overlay">
        <div class="esp-offline-message">
            <i class="bi bi-wifi-off display-1 text-danger mb-3"></i>
            <h3 class="text-danger">SISTEM OFFLINE</h3>
            <p class="text-muted">ESP32 tidak terdeteksi atau terputus</p>
            <p>Semua kontrol dinonaktifkan sampai sistem kembali online</p>
            <div class="mt-3">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                <small>Menunggu koneksi...</small>
            </div>
        </div>
    </div>

    <!-- Main Layout Container -->
    <div class="container py-3">
        <!-- Status Row -->
        <div class="row mb-3 d-flex flex-column flex-md-row">
            <div class="col-md-4 esp-status-container status-container">
                <div class="card esp-status-card" id="esp-status-card">
                    <div class="card-body p-2">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="esp-status-indicator" id="esp-status-indicator">
                                    <i class="bi bi-wifi"></i>
                                </div>
                            </div>
                            <div class="col">
                                <h6 class="mb-0" id="esp-status-title">Status Sistem</h6>
                                <small class="text-muted" id="esp-status-text">
                                    <span id="esp-status-detail">Menghubungkan ke ESP32...</span>
                                </small>
                            </div>
                            <div class="col-auto">
                                <div id="esp-status-badge">
                                    <span class="badge bg-secondary" id="esp-status-badge-text">OFFLINE</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 offset-md-4 mode-indicator-container status-container">
                <div class="mode-indicator mode-auto" id="mode-indicator">
                    <i class="bi bi-robot"></i> MODE OTOMATIS
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold"><i class="bi bi-droplet-half"></i> Smart Aquaponics</h1>
                    <p class="lead mb-0">Monitoring & Kontrol Sistem Akuaponik IoT</p>
                </div>
                <div class="col-md-4 text-end d-none d-md-block">
                    <div class="d-inline-block p-3 rounded-3" style="background: rgba(255,255,255,0.2);">
                        <div id="current-time" class="h4 mb-0">00:00:00</div>
                        <small>Waktu Sistem</small>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Time Display -->
            <div class="d-block d-md-none text-center mt-2">
                <div class="d-inline-block p-2 rounded-3" style="background: rgba(255,255,255,0.2);">
                    <div id="current-time-mobile" class="h5 mb-0">00:00:00</div>
                    <small>Waktu Sistem</small>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs-custom mt-3">
                <ul class="nav nav-tabs justify-content-center" id="mainTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="monitoring-tab" onclick="switchTab('monitoring')">
                            <i class="bi bi-graph-up"></i> Monitoring
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="calibration-tab" onclick="switchTab('calibration')">
                            <i class="bi bi-tools"></i> Kalibrasi
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Servo Active Indicator - BARU RESPONSIF -->
        <div class="servo-active-indicator" id="servo-active-indicator">
            <div class="servo-active-content">
                <div class="servo-header">
                    <i class="bi bi-gear-fill servo-gear rotating"></i>
                    <h3 class="servo-title">PEMBERIAN PAKAN</h3>
                </div>
                
                <div class="servo-progress-container">
                    <div class="servo-progress-ring">
                        <svg class="servo-progress-ring-circle" viewBox="0 0 120 120">
                            <circle class="servo-progress-ring-bg" cx="60" cy="60" r="54"></circle>
                            <circle class="servo-progress-ring-fill" cx="60" cy="60" r="54" 
                                    stroke-dasharray="339" stroke-dashoffset="339" id="servo-progress-circle"></circle>
                        </svg>
                        <div class="servo-progress-text">
                            <span class="feeding-time" id="feeding-time">3.0</span>
                            <small>DETIK</small>
                        </div>
                    </div>
                </div>
                
                <div class="servo-status">
                    <div class="servo-status-text" id="servo-status-text">Servo pakan sedang aktif...</div>
                    <div class="servo-status-subtext">Silakan tunggu hingga proses selesai</div>
                </div>
                
                <div class="servo-particles" id="servo-particles"></div>
                
                <div class="servo-action">
                    <button class="btn btn-sm btn-outline-light" onclick="skipFeeding()" id="skip-btn">
                        <i class="bi bi-skip-forward"></i> Lewati
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal-confirm" id="confirm-modal">
            <div class="modal-content-confirm">
                <div class="text-center mb-3">
                    <i class="bi bi-question-circle display-1 text-primary"></i>
                </div>
                <h4 class="text-center mb-3" id="confirm-title">Konfirmasi</h4>
                <p class="text-center text-muted mb-4" id="confirm-message"></p>
                <div class="d-flex gap-2 flex-column flex-md-row">
                    <button class="btn btn-outline-secondary flex-fill" id="cancel-btn">
                        <i class="bi bi-x-lg"></i> Batal
                    </button>
                    <button class="btn btn-primary flex-fill" id="confirm-action-btn">
                        <i class="bi bi-check-lg"></i> Ya, Lanjutkan
                    </button>
                </div>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div id="monitoring-section" class="content-section active">
            <!-- Water Quality Monitoring -->
            <div class="row mb-3">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h4 class="mb-0"><i class="bi bi-water"></i> Kualitas Air</h4>
                            <div class="d-none d-md-block">
                                <span class="quality-indicator good"></span>
                                <small>Kondisi: <span id="water-condition">Baik</span></small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <!-- Water Tank with Animation -->
                                <div class="col-md-4 text-center mb-3 mb-md-0">
                                    <div class="water-tank-container">
                                        <div class="water-tank" id="water-tank">
                                            <div class="water-level" id="water-level-visual"></div>
                                        </div>
                                    </div>
                                    <h3 class="value-display d-inline" id="water-level">0</h3>
                                    <span class="value-unit">cm</span>
                                    <p class="text-muted mt-2">Level Air Kolam</p>
                                </div>

                                <!-- Sensor Readings -->
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="sensor-card ph">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="text-uppercase text-muted mb-1">pH Air</h6>
                                                        <h2 class="value-display" id="ph-value">7.0</h2>
                                                        <small class="text-muted">Optimal: 6.5-7.5</small>
                                                    </div>
                                                    <i class="bi bi-droplet" style="color: #9c27b0;"></i>
                                                </div>
                                                <div class="sensor-progress mt-2">
                                                    <div id="ph-progress" class="sensor-progress-bar" style="width: 50%; background: #9c27b0;"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4 mb-3">
                                            <div class="sensor-card tds">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="text-uppercase text-muted mb-1">TDS</h6>
                                                        <h2 class="value-display d-inline" id="tds-value">800</h2>
                                                        <span class="value-unit">ppm</span>
                                                        <small class="text-muted d-block mt-1">Total Dissolved Solids</small>
                                                    </div>
                                                    <i class="bi bi-speedometer2" style="color: #2196f3;"></i>
                                                </div>
                                                <div class="sensor-progress mt-2">
                                                    <div id="tds-progress" class="sensor-progress-bar" style="width: 60%; background: #2196f3;"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4 mb-3">
                                            <div class="sensor-card turbidity">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="text-uppercase text-muted mb-1">Kekeruhan</h6>
                                                        <h2 class="value-display d-inline" id="turbidity-value">15</h2>
                                                        <span class="value-unit">NTU</span>
                                                        <small class="text-muted d-block mt-1">Kejernihan Air</small>
                                                    </div>
                                                    <i class="bi bi-cloud-fog" style="color: #ff9800;"></i>
                                                </div>
                                                <div class="sensor-progress mt-2">
                                                    <div id="turbidity-progress" class="sensor-progress-bar" style="width: 30%; background: #ff9800;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feed Stock -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-bucket"></i> Stok Pakan</h4>
                        </div>
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <div class="feed-container mb-3 mx-auto">
                                <div class="feed-level" id="feed-level-visual"></div>
                            </div>
                            <h2 class="value-display" id="feed-level">25</h2>
                            <span class="value-unit">cm</span>
                            <p class="text-muted mt-2">Sisa Stok Pakan</p>
                            
                            <div class="mt-3 w-100">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Kapasitas</span>
                                    <span id="feed-percentage">85%</span>
                                </div>
                                <div class="progress" style="height: 12px; border-radius: 6px;">
                                    <div id="feed-progress-bar" class="progress-bar bg-success" style="width: 85%;"></div>
                                </div>
                            </div>

                            <div class="alert alert-warning mt-3 animate__animated animate__pulse" id="feed-alert" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i> Stok pakan hampir habis!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Control -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-sliders"></i> Kontrol Sistem</h4>
                        </div>
                        <div class="card-body">
                            <!-- Mode Selection -->
                            <div class="row mb-3">
                                <div class="col-md-6 mb-2">
                                    <button class="control-btn btn btn-success w-100 py-2" onclick="setMode('auto')" id="btn-mode-auto">
                                        <i class="bi bi-robot fs-5"></i>
                                        <div class="mt-1">Mode Otomatis</div>                                        
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button class="control-btn btn btn-warning w-100 py-2" onclick="setMode('manual')" id="btn-mode-manual">
                                        <i class="bi bi-hand-index fs-5"></i>
                                        <div class="mt-1">Mode Manual</div>
                                        <small class="d-none d-md-block">Kontrol manual semua perangkat</small>
                                    </button>
                                </div>
                            </div>

                            <!-- Control Cards -->
                            <div class="row">
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="control-card">
                                        <div class="control-status status-off" id="pompa-isi-status-indicator"></div>
                                        <i class="bi bi-droplet control-icon"></i>
                                        <h5>Pompa Isi Air</h5>
                                        <p class="text-muted small d-none d-md-block">Mengisi air ke kolam ikan</p>
                                        <div class="control-buttons">
                                            <button class="control-btn btn-on" onclick="controlDevice('pompa-isi', 'on')" id="btn-pompa-isi-on">
                                                <i class="bi bi-play-fill"></i> ON
                                            </button>
                                            <button class="control-btn btn-off" onclick="controlDevice('pompa-isi', 'off')" id="btn-pompa-isi-off">
                                                <i class="bi bi-stop-fill"></i> OFF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 col-6 mb-3">
                                    <div class="control-card">
                                        <div class="control-status status-off" id="pompa-buang-status-indicator"></div>
                                        <i class="bi bi-droplet-fill control-icon"></i>
                                        <h5>Pompa Buang Air</h5>
                                        <p class="text-muted small d-none d-md-block">Menguras air dari kolam</p>
                                        <div class="control-buttons">
                                            <button class="control-btn btn-on" onclick="controlDevice('pompa-buang', 'on')" id="btn-pompa-buang-on">
                                                <i class="bi bi-play-fill"></i> ON
                                            </button>
                                            <button class="control-btn btn-off" onclick="controlDevice('pompa-buang', 'off')" id="btn-pompa-buang-off">
                                                <i class="bi bi-stop-fill"></i> OFF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 col-6 mb-3">
                                    <div class="control-card">
                                        <div class="control-status status-off" id="irigasi-status-indicator"></div>
                                        <i class="bi bi-droplet control-icon"></i>
                                        <h5>Sistem Irigasi</h5>
                                        <p class="text-muted small d-none d-md-block">Mengairi tanaman hidroponik</p>
                                        <div class="control-buttons">
                                            <button class="control-btn btn-on" onclick="controlDevice('irigasi', 'on')" id="btn-irigasi-on">
                                                <i class="bi bi-play-fill"></i> ON
                                            </button>
                                            <button class="control-btn btn-off" onclick="controlDevice('irigasi', 'off')" id="btn-irigasi-off">
                                                <i class="bi bi-stop-fill"></i> OFF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Feed Control -->
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="feed-management-card" id="feed-control-card">
                                        <div class="row">
                                            <div class="col-12 mb-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">Kontrol Pakan</h5>
                                                    <div class="control-status status-off" id="servo-status-indicator"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-12 mb-2">
                                                <button class="control-btn btn-on w-100" onclick="feedNow()" id="feed-now-btn">
                                                    <i class="bi bi-bucket-fill"></i> BERI PAKAN
                                                </button>
                                            </div>

                                            <!-- Slider -->
                                            <div class="col-12">
                                                <div class="slider-container">
                                                    <h6 class="mb-2">Jumlah Pakan:</h6>
                                                    <input type="range" min="1" max="100" value="50" class="custom-slider" id="feed-amount-slider">
                                                    
                                                    <div class="slider-labels">
                                                        <span class="slider-label" id="label-sedikit">Sedikit</span>
                                                        <span class="slider-label active" id="label-sedang">Sedang</span>
                                                        <span class="slider-label" id="label-banyak">Banyak</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riwayat Pakan Terakhir -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="feed-history-card" id="feed-history-card">
                        <div class="feed-history-header">
                            <h5 class="feed-history-title">
                                <i class="bi bi-clock-history me-2"></i>Riwayat Pakan Terakhir
                            </h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="clearFeedHistory()">
                                <i class="bi bi-trash"></i> Hapus
                            </button>
                        </div>
                        
                        <div class="feed-history-content" id="feed-history-content">
                            <!-- Konten riwayat akan dimuat di sini -->
                            <div class="feed-history-empty" id="feed-history-empty">
                                <i class="bi bi-info-circle d-block mb-2" style="font-size: 2rem;"></i>
                                Belum ada riwayat pakan
                            </div>
                            
                            <div id="feed-history-details" style="display: none;">
                                <div class="feed-history-item">
                                    <span class="feed-history-label">Status Terakhir:</span>
                                    <span class="feed-history-value success" id="last-feed-status">Selesai</span>
                                </div>
                                
                                <div class="feed-history-item">
                                    <span class="feed-history-label">Waktu:</span>
                                    <span class="feed-history-value" id="last-feed-time">-</span>
                                </div>
                                
                                <div class="feed-history-item">
                                    <span class="feed-history-label">Durasi:</span>
                                    <span class="feed-history-value" id="last-feed-duration">-</span>
                                </div>
                                
                                <div class="feed-history-item">
                                    <span class="feed-history-label">Jumlah Pakan:</span>
                                    <span class="feed-history-value" id="last-feed-amount">-</span>
                                </div>
                                
                                <div class="feed-history-item">
                                    <span class="feed-history-label">Mode:</span>
                                    <span class="feed-history-value" id="last-feed-mode">-</span>
                                </div>
                                
                                <div class="feed-history-timestamp" id="last-feed-timestamp">
                                    Terakhir diperbarui: -
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calibration Section -->
        <div id="calibration-section" class="content-section">
            <div class="row">
                <!-- Calibration Controls -->
                <div class="col-md-8 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-sliders"></i> Kalibrasi Offset Sensor</h4>
                        </div>
                        <div class="card-body">
                            <!-- Level Air -->
                            <div class="calibration-step active" id="step-air">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="calibration-step-number">1</span>
                                    <h5 class="mb-0">Kalibrasi Level Air</h5>
                                </div>
                                <p class="text-muted mb-2">Atur offset untuk kalibrasi sensor level air.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nilai Terbaca: <span class="fw-bold" id="read-value-air">35.0 cm</span></label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Offset (cm)</span>
                                        <input type="number" class="form-control" id="offset-air" step="0.1" placeholder="0.0">
                                        <button class="btn btn-outline-primary" onclick="setOffsetCalibration('air', this)">
                                            <i class="bi bi-check-lg"></i> Terapkan
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="auto-calibration">
                                    <h6><i class="bi bi-robot"></i> Auto Kalibrasi</h6>
                                    <p class="text-muted small">Masukkan nilai referensi aktual untuk kalibrasi otomatis.</p>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Nilai Referensi</span>
                                        <input type="number" class="form-control" id="reference-air" step="0.1" value="35.0">
                                        <button class="btn btn-success" onclick="autoCalibrate('air')">
                                            <i class="bi bi-gear"></i> Auto Kalibrasi
                                        </button>
                                    </div>
                                    <small class="text-muted">Sistem akan menghitung offset otomatis berdasarkan nilai referensi.</small>
                                </div>
                            </div>

                            <!-- pH -->
                            <div class="calibration-step" id="step-ph">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="calibration-step-number">2</span>
                                    <h5 class="mb-0">Kalibrasi pH Meter</h5>
                                </div>
                                <p class="text-muted mb-2">Atur offset untuk kalibrasi sensor pH.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nilai Terbaca: <span class="fw-bold" id="read-value-ph">7.2 pH</span></label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Offset (pH)</span>
                                        <input type="number" class="form-control" id="offset-ph" step="0.01" placeholder="0.00">
                                        <button class="btn btn-outline-primary" onclick="setOffsetCalibration('ph', this)">
                                            <i class="bi bi-check-lg"></i> Terapkan
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="auto-calibration">
                                    <h6><i class="bi bi-robot"></i> Auto Kalibrasi</h6>
                                    <p class="text-muted small">Masukkan nilai referensi aktual untuk kalibrasi otomatis.</p>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Nilai Referensi</span>
                                        <input type="number" class="form-control" id="reference-ph" step="0.01" value="7.00">
                                        <button class="btn btn-success" onclick="autoCalibrate('ph')">
                                            <i class="bi bi-gear"></i> Auto Kalibrasi
                                        </button>
                                    </div>
                                    <small class="text-muted">Gunakan larutan buffer pH 4.0, 7.0, atau 10.0 sebagai referensi.</small>
                                </div>
                            </div>

                            <!-- TDS -->
                            <div class="calibration-step" id="step-tds">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="calibration-step-number">3</span>
                                    <h5 class="mb-0">Kalibrasi TDS</h5>
                                </div>
                                <p class="text-muted mb-2">Atur offset untuk kalibrasi sensor TDS.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nilai Terbaca: <span class="fw-bold" id="read-value-tds">850 ppm</span></label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Offset (ppm)</span>
                                        <input type="number" class="form-control" id="offset-tds" step="1" placeholder="0">
                                        <button class="btn btn-outline-primary" onclick="setOffsetCalibration('tds', this)">
                                            <i class="bi bi-check-lg"></i> Terapkan
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="auto-calibration">
                                    <h6><i class="bi bi-robot"></i> Auto Kalibrasi</h6>
                                    <p class="text-muted small">Masukkan nilai referensi aktual untuk kalibrasi otomatis.</p>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Nilai Referensi</span>
                                        <input type="number" class="form-control" id="reference-tds" step="1" value="1000">
                                        <button class="btn btn-success" onclick="autoCalibrate('tds')">
                                            <i class="bi bi-gear"></i> Auto Kalibrasi
                                        </button>
                                    </div>
                                    <small class="text-muted">Gunakan larutan kalibrasi 1413 S/cm atau 1000 ppm sebagai referensi.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <!-- System Settings -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-gear"></i> Pengaturan Sistem</h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Interval Pengiriman Data (detik)</label>
                                <input type="number" class="form-control" id="data-interval" value="5" min="1" max="60">
                                <div class="form-text">Interval pengiriman data ke server</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Threshold Peringatan Level Air Rendah (cm)</label>
                                <input type="number" class="form-control" id="warning-water-low" value="15" step="0.1">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Threshold Peringatan Level Air Tinggi (cm)</label>
                                <input type="number" class="form-control" id="warning-water-high" value="55" step="0.1">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Threshold Peringatan Level Pakan (cm)</label>
                                <input type="number" class="form-control" id="warning-feed" value="5" step="0.1">
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-primary" onclick="confirmSaveSettings()" id="btn-save-settings">
                                    <i class="bi bi-save"></i> Simpan Pengaturan
                                </button>
                                <button class="btn btn-outline-danger" onclick="confirmResetCalibration()" id="btn-reset-calibration">
                                    <i class="bi bi-arrow-clockwise"></i> Reset Kalibrasi
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Last Calibration History -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-clock-history"></i> Riwayat Kalibrasi</h4>
                        </div>
                        <div class="card-body">
                            <div id="calibration-history-container">
                                <div class="text-center text-muted py-3" id="empty-history">
                                    <i class="bi bi-clock-history display-4 mb-2"></i>
                                    <p>Belum ada riwayat kalibrasi</p>
                                </div>
                                
                                <div id="history-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification" id="notification-container"></div>

    <script>
        // ============================================
        // KONFIGURASI AWAL
        // ============================================
        
        // MQTT Connection
        const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

        // Variabel untuk Monitoring
        let currentFeedAmount = 50;
        let currentMode = 'auto';
        let isServoActive = false;
        let feedingInterval = null;
        let feedingDuration = 0;
        let feedingStartTime = null;
        
        // Variabel untuk kontrol debounce
        let lastControlTime = {};
        
        // Variabel untuk ESP32 Status
        let espOnline = false;
        let lastHeartbeatTime = 0;
        const HEARTBEAT_TIMEOUT = 10000;
        
        // Variabel untuk Kalibrasi
        let lastCalibrationData = JSON.parse(localStorage.getItem('lastCalibrationData')) || {
            air: null,
            ph: null,
            tds: null,
            turbidity: null,
            feed: null
        };
        
        // Variabel untuk animasi servo baru
        let servoParticlesInterval = null;
        let servoProgressInterval = null;
        let servoRemainingTime = 0;
        let servoTotalTime = 0;
        
        // Variabel untuk Riwayat Pakan
        let lastFeedingHistory = JSON.parse(localStorage.getItem('lastFeedingHistory')) || {
            timestamp: null,
            duration: 0,
            amount: 0,
            status: 'idle', // idle, active, completed, skipped, error
            mode: 'manual', // manual, auto
            feedCode: '2' // 1, 2, 3
        };
        
        // Data sensor saat ini
        let currentSensorValues = {
            air: 35.0,
            ph: 7.2,
            tds: 850,
            turbidity: 12.5,
            feed: 22.0
        };

        // Mapping sensor type ke nama dan unit
        const sensorInfo = {
            air: { name: 'Level Air', unit: 'cm' },
            ph: { name: 'pH Meter', unit: 'pH' },
            tds: { name: 'TDS Sensor', unit: 'ppm' },
            turbidity: { name: 'Sensor Kekeruhan', unit: 'NTU' },
            feed: { name: 'Level Pakan', unit: 'cm' }
        };

        // Mapping topic MQTT untuk offset
        const offsetTopics = {
            air: 'akuaponik/kalibrasi/offset_air',
            ph: 'akuaponik/kalibrasi/offset_ph',
            tds: 'akuaponik/kalibrasi/offset_tds',
            turbidity: 'akuaponik/kalibrasi/offset_turbidity',
            feed: 'akuaponik/kalibrasi/offset_pakan'
        };

        // ============================================
        // FUNGSI NAVIGASI
        // ============================================

        function switchTab(tabName) {
            // Update tab buttons
            document.getElementById('monitoring-tab').classList.remove('active');
            document.getElementById('calibration-tab').classList.remove('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Show selected section
            document.getElementById('monitoring-section').classList.remove('active');
            document.getElementById('calibration-section').classList.remove('active');
            document.getElementById(tabName + '-section').classList.add('active');
        }

        // ============================================
        // FUNGSI ESP32 STATUS MANAGEMENT
        // ============================================

        function updateESPStatus(online) {
            espOnline = online;
            const now = Date.now();
            
            const statusCard = document.getElementById('esp-status-card');
            const statusIndicator = document.getElementById('esp-status-indicator');
            const statusDetail = document.getElementById('esp-status-detail');
            const statusBadge = document.getElementById('esp-status-badge-text');
            const overlay = document.getElementById('esp-offline-overlay');
            
            if (online) {
                lastHeartbeatTime = now;
                
                // Update tampilan - ONLINE
                statusCard.classList.remove('offline');
                statusCard.classList.add('online');
                statusIndicator.classList.remove('offline');
                statusIndicator.classList.add('online');
                statusIndicator.innerHTML = '<i class="bi bi-wifi"></i>';
                statusDetail.textContent = 'Terhubung ke ESP32 & Server';
                statusBadge.textContent = 'ONLINE';
                statusBadge.className = 'badge bg-success';
                
                // Sembunyikan overlay
                overlay.classList.remove('active');
                
                // Enable kontrol berdasarkan mode
                updateControlState();
                
            } else {
                // Update tampilan - OFFLINE
                statusCard.classList.remove('online');
                statusCard.classList.add('offline');
                statusIndicator.classList.remove('online');
                statusIndicator.classList.add('offline');
                statusIndicator.innerHTML = '<i class="bi bi-wifi-off"></i>';
                statusDetail.textContent = 'ESP32 tidak terdeteksi';
                statusBadge.textContent = 'OFFLINE';
                statusBadge.className = 'badge bg-danger';
                
                // Tampilkan overlay
                overlay.classList.add('active');
                
                // DISABLE SEMUA KONTROL
                disableAllControls();
            }
        }

        function disableAllControls() {
            const controlButtons = [
                'btn-pompa-isi-on', 'btn-pompa-isi-off',
                'btn-pompa-buang-on', 'btn-pompa-buang-off',
                'btn-irigasi-on', 'btn-irigasi-off',
                'feed-now-btn',
                'btn-mode-auto', 'btn-mode-manual'
            ];
            
            controlButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                }
            });
            
            const slider = document.getElementById('feed-amount-slider');
            if (slider) {
                slider.disabled = true;
                slider.style.opacity = '0.5';
            }
        }

        function updateControlState() {
            if (!espOnline) {
                disableAllControls();
                return;
            }
            
            if (currentMode === 'manual') {
                enableManualControls();
            } else {
                disableManualControls();
            }
            
            enableModeButtons();
        }

        function enableManualControls() {
            const manualButtons = [
                'btn-pompa-isi-on', 'btn-pompa-isi-off',
                'btn-pompa-buang-on', 'btn-pompa-buang-off',
                'btn-irigasi-on', 'btn-irigasi-off',
                'feed-now-btn'
            ];
            
            manualButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                }
            });
            
            const slider = document.getElementById('feed-amount-slider');
            if (slider) {
                slider.disabled = false;
                slider.style.opacity = '1';
            }
        }

        function disableManualControls() {
            const manualButtons = [
                'btn-pompa-isi-on', 'btn-pompa-isi-off',
                'btn-pompa-buang-on', 'btn-pompa-buang-off',
                'btn-irigasi-on', 'btn-irigasi-off',
                'feed-now-btn'
            ];
            
            manualButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                }
            });
            
            const slider = document.getElementById('feed-amount-slider');
            if (slider) {
                slider.disabled = true;
                slider.style.opacity = '0.5';
            }
        }

        function enableModeButtons() {
            const modeButtons = ['btn-mode-auto', 'btn-mode-manual'];
            modeButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                }
            });
        }

        function startHeartbeatChecker() {
            setInterval(() => {
                const now = Date.now();
                if (lastHeartbeatTime > 0 && (now - lastHeartbeatTime) > HEARTBEAT_TIMEOUT) {
                    if (espOnline) {
                        console.log('Heartbeat timeout - ESP32 offline');
                        updateESPStatus(false);
                        showNotification('ESP32 terputus - Sistem offline', 'danger');
                    }
                }
            }, 1000);
        }

        // ============================================
        // FUNGSI MONITORING
        // ============================================

        function generateWaterAnimations() {
            const tank = document.getElementById('water-tank');
            if (!tank) return;
            
            // Clear existing fish
            tank.querySelectorAll('.fish').forEach(fish => fish.remove());
            tank.querySelectorAll('.bubble').forEach(bubble => bubble.remove());
            
            // Add fish
            for (let i = 0; i < 3; i++) {
                const fish = document.createElement('div');
                fish.className = 'fish';
                fish.style.bottom = `${15 + i * 25}%`;
                fish.style.left = `${10 + i * 25}%`;
                fish.style.animationDelay = `${i * 1.5}s`;
                tank.appendChild(fish);
            }
            
            // Add bubbles
            setInterval(() => {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                const size = 3 + Math.random() * 8;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${30 + Math.random() * 40}%`;
                bubble.style.bottom = '0';
                bubble.style.animationDuration = `${1.5 + Math.random() * 2}s`;
                tank.appendChild(bubble);
                
                setTimeout(() => bubble.remove(), 3500);
            }, 800);
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            document.getElementById('current-time').textContent = timeString;
            document.getElementById('current-time-mobile').textContent = timeString;
        }

        function updateWaterCondition() {
            const ph = parseFloat(document.getElementById('ph-value').textContent);
            const tds = parseFloat(document.getElementById('tds-value').textContent);
            const turbidity = parseFloat(document.getElementById('turbidity-value').textContent);
            
            let condition = "Baik";
            let indicatorClass = "good";
            
            if (ph < 6 || ph > 8 || tds > 2000 || turbidity > 50) {
                condition = "Perhatian";
                indicatorClass = "warning";
            }
            if (ph < 5 || ph > 9 || tds > 3000 || turbidity > 100) {
                condition = "Bahaya";
                indicatorClass = "danger";
            }
            
            document.getElementById('water-condition').textContent = condition;
            const indicator = document.querySelector('.quality-indicator');
            if (indicator) {
                indicator.className = `quality-indicator ${indicatorClass}`;
            }
        }

        function updateControlStatusFromESP32(device, isOn) {
            let elementId = '';
            if (device === 'PompaIsi') elementId = 'pompa-isi-status-indicator';
            else if (device === 'PompaBuang') elementId = 'pompa-buang-status-indicator';
            else if (device === 'Irigasi') elementId = 'irigasi-status-indicator';
            else if (device === 'Servo') elementId = 'servo-status-indicator';
            else if (device === 'Manual') {
                if (isOn) {
                    updateModeIndicator(false);
                    currentMode = 'manual';
                    if (espOnline) enableManualControls();
                }
                return;
            } else if (device === 'Otomatis') {
                if (isOn) {
                    updateModeIndicator(true);
                    currentMode = 'auto';
                    if (espOnline) disableManualControls();
                }
                return;
            }
            
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.className = `control-status ${isOn ? 'status-on' : 'status-off'}`;
                    element.style.background = isOn ? '#4caf50' : '#f44336';
                }
            }
        }

        function updateModeIndicator(isAuto) {
            const modeIndicator = document.getElementById('mode-indicator');
            currentMode = isAuto ? 'auto' : 'manual';
            
            if (isAuto) {
                modeIndicator.innerHTML = '<i class="bi bi-robot"></i> MODE OTOMATIS';
                modeIndicator.className = 'mode-indicator mode-auto';
            } else {
                modeIndicator.innerHTML = '<i class="bi bi-hand-index"></i> MODE MANUAL';
                modeIndicator.className = 'mode-indicator mode-manual';
            }
        }

        function updateSliderLabels(percentage) {
            document.querySelectorAll('.slider-label').forEach(label => {
                label.classList.remove('active');
            });
            
            if (percentage <= 33) {
                document.getElementById('label-sedikit').classList.add('active');
            } else if (percentage <= 66) {
                document.getElementById('label-sedang').classList.add('active');
            } else {
                document.getElementById('label-banyak').classList.add('active');
            }
        }

        // ============================================
        // FUNGSI ANIMASI SERVO RESPONSIF (BARU)
        // ============================================

        function showServoActiveIndicator(duration) {
            if (isServoActive) return;
            
            isServoActive = true;
            servoTotalTime = duration;
            servoRemainingTime = duration;
            
            const indicator = document.getElementById('servo-active-indicator');
            const feedCard = document.getElementById('feed-control-card');
            const skipBtn = document.getElementById('skip-btn');
            
            // Reset dan tampilkan indicator
            indicator.style.display = 'block';
            indicator.style.animation = 'servoAppear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
            
            // Update status text
            document.getElementById('servo-status-text').textContent = 'Servo pakan sedang aktif...';
            
            // Update feed card
            if (feedCard) {
                feedCard.classList.add('feeding-active');
            }
            
            // Enable skip button
            if (skipBtn) {
                skipBtn.disabled = false;
                skipBtn.innerHTML = '<i class="bi bi-skip-forward"></i> Lewati';
            }
            
            // Reset progress circle
            const progressCircle = document.getElementById('servo-progress-circle');
            const circumference = 339; // 2 *  * 54
            progressCircle.style.strokeDasharray = circumference;
            progressCircle.style.strokeDashoffset = circumference;
            
            // Start animations
            startServoProgress();
            generateServoParticles();
            
            // Update feeding history
            updateFeedingHistory('active', duration, currentFeedAmount, currentMode);
            
            // Auto hide after duration
            setTimeout(() => {
                if (isServoActive) {
                    hideServoActiveIndicator(true);
                }
            }, duration * 1000 + 500);
        }

        function generateServoParticles() {
            if (servoParticlesInterval) clearInterval(servoParticlesInterval);
            
            const particlesContainer = document.getElementById('servo-particles');
            if (!particlesContainer) return;
            
            // Clear existing particles
            particlesContainer.innerHTML = '';
            
            // Generate particles based on screen size
            const particleCount = window.innerWidth < 768 ? 8 : 15;
            
            servoParticlesInterval = setInterval(() => {
                if (!isServoActive) {
                    clearInterval(servoParticlesInterval);
                    return;
                }
                
                createServoParticle(particlesContainer, particleCount);
            }, 300);
        }

        function createServoParticle(container, maxParticles) {
            const particleCount = Math.min(maxParticles, container.children.length < maxParticles ? 
                Math.floor(Math.random() * 3) + 1 : 0);
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random size based on device
                const size = window.innerWidth < 768 ? 
                    Math.random() * 8 + 4 : 
                    Math.random() * 14 + 6;
                
                // Random position
                const posX = Math.random() * 100;
                const posY = Math.random() * 100;
                
                // Random animation properties
                const tx = (Math.random() - 0.5) * 100;
                const ty = -Math.random() * 80 - 20;
                const r = (Math.random() - 0.5) * 180;
                
                // Set styles
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${posX}%`;
                particle.style.top = `${posY}%`;
                particle.style.opacity = '0';
                
                // Set CSS custom properties for animation
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                particle.style.setProperty('--r', `${r}deg`);
                
                // Animation
                particle.style.animation = `particleFloat 1.5s ease-out forwards`;
                
                container.appendChild(particle);
                
                // Remove particle after animation
                setTimeout(() => {
                    if (particle.parentNode === container) {
                        particle.remove();
                    }
                }, 1500);
            }
        }

        function startServoProgress() {
            if (servoProgressInterval) clearInterval(servoProgressInterval);
            
            const progressCircle = document.getElementById('servo-progress-circle');
            const circumference = 339;
            
            servoProgressInterval = setInterval(() => {
                if (!isServoActive || servoRemainingTime <= 0) {
                    clearInterval(servoProgressInterval);
                    return;
                }
                
                // Update time
                servoRemainingTime = Math.max(0, servoRemainingTime - 0.1);
                const progressPercent = 100 - (servoRemainingTime / servoTotalTime) * 100;
                
                // Update progress circle
                const offset = circumference - (progressPercent / 100) * circumference;
                progressCircle.style.strokeDashoffset = offset;
                
                // Update time display
                document.getElementById('feeding-time').textContent = servoRemainingTime.toFixed(1);
                
                // Change color based on progress
                if (progressPercent > 66) {
                    progressCircle.style.stroke = '#4CAF50'; // Green for completion
                } else if (progressPercent > 33) {
                    progressCircle.style.stroke = '#FF9800'; // Orange for middle
                }
                
                // Update status text based on progress
                const statusText = document.getElementById('servo-status-text');
                if (servoRemainingTime <= 0.5) {
                    statusText.textContent = 'Menyelesaikan pemberian pakan...';
                } else if (servoRemainingTime <= servoTotalTime * 0.5) {
                    statusText.textContent = 'Pemberian pakan setengah jalan...';
                }
                
            }, 100);
        }

        function hideServoActiveIndicator(success = true) {
            if (!isServoActive) return;
            
            isServoActive = false;
            const indicator = document.getElementById('servo-active-indicator');
            const feedCard = document.getElementById('feed-control-card');
            
            // Stop animations
            if (servoParticlesInterval) {
                clearInterval(servoParticlesInterval);
                servoParticlesInterval = null;
            }
            
            if (servoProgressInterval) {
                clearInterval(servoProgressInterval);
                servoProgressInterval = null;
            }
            
            // Clear particles
            const particlesContainer = document.getElementById('servo-particles');
            if (particlesContainer) {
                particlesContainer.innerHTML = '';
            }
            
            // Animate out
            if (indicator) {
                indicator.style.animation = 'servoDisappear 0.3s ease-out forwards';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 300);
            }
            
            // Remove feed card animation
            if (feedCard) {
                feedCard.classList.remove('feeding-active');
            }
            
            // Update feeding history
            const status = success ? 'completed' : 'skipped';
            updateFeedingHistory(status, servoTotalTime, currentFeedAmount, currentMode);
            
            // Show notification if success
            if (success) {
                setTimeout(() => {
                    showNotification('Pemberian pakan selesai!', 'success');
                }, 500);
            }
        }

        function skipFeeding() {
            if (!isServoActive) return;
            
            const skipBtn = document.getElementById('skip-btn');
            if (skipBtn) {
                skipBtn.disabled = true;
                skipBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Lewati...';
            }
            
            // Send stop command to ESP32
            if (espOnline) {
                client.publish('akuaponik/kendali/servo', '0');
            }
            
            // Hide immediately
            hideServoActiveIndicator(false);
            
            showNotification('Pemberian pakan dihentikan', 'warning');
        }

        // ============================================
        // FUNGSI RIWAYAT PAKAN
        // ============================================

        function updateFeedingHistory(status, duration, amount, mode) {
            const now = new Date();
            const feedCode = getFeedCodeFromPercentage(amount);
            
            // Update history object
            lastFeedingHistory = {
                timestamp: now.getTime(),
                duration: duration,
                amount: amount,
                status: status,
                mode: mode,
                feedCode: feedCode,
                formattedTime: now.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }),
                formattedDate: now.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                })
            };
            
            // Save to localStorage
            localStorage.setItem('lastFeedingHistory', JSON.stringify(lastFeedingHistory));
            
            // Update display
            updateFeedingHistoryDisplay();
            
            // Log untuk debugging
            console.log('Riwayat pakan diperbarui:', lastFeedingHistory);
        }

        function updateFeedingHistoryDisplay() {
            const emptyElement = document.getElementById('feed-history-empty');
            const detailsElement = document.getElementById('feed-history-details');
            
            if (!lastFeedingHistory.timestamp) {
                // No history yet
                if (emptyElement) emptyElement.style.display = 'block';
                if (detailsElement) detailsElement.style.display = 'none';
                return;
            }
            
            // Show details and hide empty message
            if (emptyElement) emptyElement.style.display = 'none';
            if (detailsElement) detailsElement.style.display = 'block';
            
            // Update status
            const statusElement = document.getElementById('last-feed-status');
            if (statusElement) {
                let statusText = 'Tidak diketahui';
                let statusClass = '';
                
                switch(lastFeedingHistory.status) {
                    case 'active':
                        statusText = 'Sedang Berjalan';
                        statusClass = 'warning';
                        break;
                    case 'completed':
                        statusText = 'Selesai';
                        statusClass = 'success';
                        break;
                    case 'skipped':
                        statusText = 'Dibatalkan';
                        statusClass = 'warning';
                        break;
                    case 'error':
                        statusText = 'Error';
                        statusClass = 'warning';
                        break;
                    case 'idle':
                        statusText = 'Tidak Aktif';
                        statusClass = '';
                        break;
                }
                
                statusElement.textContent = statusText;
                statusElement.className = `feed-history-value ${statusClass}`;
            }
            
            // Update time
            const timeElement = document.getElementById('last-feed-time');
            if (timeElement && lastFeedingHistory.formattedTime) {
                timeElement.textContent = `${lastFeedingHistory.formattedTime}`;
            }
            
            // Update duration
            const durationElement = document.getElementById('last-feed-duration');
            if (durationElement) {
                durationElement.textContent = `${lastFeedingHistory.duration.toFixed(1)} detik`;
            }
            
            // Update amount
            const amountElement = document.getElementById('last-feed-amount');
            if (amountElement) {
                let amountText = 'Sedang';
                if (lastFeedingHistory.feedCode === '1') amountText = 'Sedikit';
                else if (lastFeedingHistory.feedCode === '3') amountText = 'Banyak';
                amountElement.textContent = `${amountText} (${lastFeedingHistory.amount}%)`;
            }
            
            // Update mode
            const modeElement = document.getElementById('last-feed-mode');
            if (modeElement) {
                modeElement.textContent = lastFeedingHistory.mode === 'auto' ? 'Otomatis' : 'Manual';
            }
            
            // Update timestamp
            const timestampElement = document.getElementById('last-feed-timestamp');
            if (timestampElement && lastFeedingHistory.formattedDate) {
                const now = new Date();
                const diffMs = now.getTime() - lastFeedingHistory.timestamp;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                let timeAgo = '';
                if (diffDays > 0) {
                    timeAgo = `${diffDays} hari yang lalu`;
                } else if (diffHours > 0) {
                    timeAgo = `${diffHours} jam yang lalu`;
                } else if (diffMins > 0) {
                    timeAgo = `${diffMins} menit yang lalu`;
                } else {
                    timeAgo = 'Baru saja';
                }
                
                timestampElement.textContent = `Terakhir diperbarui: ${lastFeedingHistory.formattedDate} ${lastFeedingHistory.formattedTime} (${timeAgo})`;
            }
            
            // Update card animation based on status
            const historyCard = document.getElementById('feed-history-card');
            if (historyCard) {
                // Remove previous animation classes
                historyCard.classList.remove('feeding-active');
                
                // Add animation if active
                if (lastFeedingHistory.status === 'active') {
                    historyCard.classList.add('feeding-active');
                }
            }
        }

        function clearFeedHistory() {
            if (confirm('Apakah Anda yakin ingin menghapus riwayat pakan?')) {
                lastFeedingHistory = {
                    timestamp: null,
                    duration: 0,
                    amount: 0,
                    status: 'idle',
                    mode: 'manual',
                    feedCode: '2'
                };
                
                localStorage.removeItem('lastFeedingHistory');
                updateFeedingHistoryDisplay();
                
                showNotification('Riwayat pakan telah dihapus', 'info');
            }
        }

        // ============================================
        // FUNGSI MONITORING LANJUTAN
        // ============================================

        function checkFeedLevel(level, max = 29) {
            const percent = (level / max) * 100;
            const alertElement = document.getElementById('feed-alert');
            
            if (alertElement) {
                if (percent < 20) {
                    alertElement.style.display = 'block';
                    alertElement.classList.add('animate__animated', 'animate__headShake');
                } else {
                    alertElement.style.display = 'none';
                }
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show shadow-lg mb-2`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="this.parentElement.remove()"></button>
            `;
            
            const container = document.getElementById('notification-container');
            if (container) {
                container.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode === container) {
                        notification.remove();
                    }
                }, 5000);
            }
        }

        function getFeedCodeFromPercentage(percentage) {
            if (percentage <= 33) return "1";
            if (percentage <= 66) return "2";
            return "3";
        }

        function feedNow() {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat memberi pakan', 'danger');
                return;
            }
            
            if (currentMode === 'auto') {
                showNotification('Tidak bisa memberi pakan manual saat mode otomatis aktif!', 'warning');
                return;
            }
            
            if (isServoActive) {
                showNotification('Servo pakan masih aktif. Tunggu sampai selesai.', 'warning');
                return;
            }
            
            const now = Date.now();
            if (lastControlTime['servo'] && now - lastControlTime['servo'] < 1000) {
                showNotification('Tunggu sebentar sebelum memberi pakan lagi', 'warning');
                return;
            }
            lastControlTime['servo'] = now;
            
            const feedCode = getFeedCodeFromPercentage(currentFeedAmount);
            
            // Duration mapping
            const durationMap = {
                '1': 0.5,  // Sedikit
                '2': 1.5,  // Sedang
                '3': 3.0   // Banyak
            };
            
            const feedBtn = document.getElementById('feed-now-btn');
            if (feedBtn) {
                feedBtn.disabled = true;
                feedBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';
            }
            
            showControlLoading('servo', true);
            
            client.publish('akuaponik/kendali/servo', '1');
            client.publish('akuaponik/pakan/durasi', feedCode);
            
            showNotification(`Mengirim perintah pakan (kode: ${feedCode})`, 'info');
            
            setTimeout(() => {
                if (feedBtn) {
                    feedBtn.disabled = false;
                    feedBtn.innerHTML = '<i class="bi bi-bucket-fill"></i> BERI PAKAN';
                }
                showControlLoading('servo', false);
            }, 2000);
        }

        function updateWaterVisual(current, max) {
            const percent = (current / max) * 100;
            const waterLevel = document.getElementById('water-level-visual');
            if (waterLevel) {
                waterLevel.style.height = `${Math.min(percent, 100)}%`;
            }
            
            document.getElementById('water-level').textContent = current.toFixed(1);
            
            // Update progress bars for sensors
            const phValue = parseFloat(document.getElementById('ph-value').textContent);
            const tdsValue = parseFloat(document.getElementById('tds-value').textContent);
            const turbidityValue = parseFloat(document.getElementById('turbidity-value').textContent);
            
            document.getElementById('ph-progress').style.width = `${(phValue / 14) * 100}%`;
            document.getElementById('tds-progress').style.width = `${Math.min(100, (tdsValue / 5000) * 100)}%`;
            document.getElementById('turbidity-progress').style.width = `${Math.min(100, (turbidityValue / 1000) * 100)}%`;
        }

        function updateFeedVisual(current, max) {
            const percent = (current / max) * 100;
            const feedLevel = document.getElementById('feed-level-visual');
            if (feedLevel) {
                feedLevel.style.height = `${Math.min(percent, 100)}%`;
            }
            
            document.getElementById('feed-level').textContent = current.toFixed(1);
            document.getElementById('feed-percentage').textContent = `${Math.round(percent)}%`;
            document.getElementById('feed-progress-bar').style.width = `${percent}%`;
            
            checkFeedLevel(current, max);
        }

        function disableControlButtons(device, disable) {
            const onBtn = document.getElementById(`btn-${device}-on`);
            const offBtn = document.getElementById(`btn-${device}-off`);
            
            if (onBtn) onBtn.disabled = disable;
            if (offBtn) offBtn.disabled = disable;
            
            if (device === 'servo') {
                const feedBtn = document.getElementById('feed-now-btn');
                if (feedBtn) feedBtn.disabled = disable;
            }
        }

        function showControlLoading(device, show) {
            const indicator = document.getElementById(`${device}-status-indicator`);
            if (!indicator) return;
            
            if (show) {
                indicator.className = 'control-status status-loading';
                indicator.style.background = '#ff9800';
                indicator.style.animation = 'pulse 1s infinite';
            }
        }

        function setMode(mode) {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mengubah mode', 'danger');
                return;
            }
            
            if (mode === 'auto') {
                client.publish('akuaponik/mode/Otomatis', '1');
                client.publish('akuaponik/mode/Manual', '0');
                
                updateModeIndicator(true);
                currentMode = 'auto';
                if (espOnline) {
                    disableManualControls();
                }
                
                showNotification('Mode diubah ke Otomatis', 'success');
                
            } else {
                client.publish('akuaponik/mode/Manual', '1');
                client.publish('akuaponik/mode/Otomatis', '0');
                
                updateModeIndicator(false);
                currentMode = 'manual';
                if (espOnline) {
                    enableManualControls();
                }
                
                showNotification('Mode diubah ke Manual', 'warning');
            }
        }

        function controlDevice(device, state) {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mengirim perintah', 'danger');
                return;
            }
            
            if (currentMode === 'auto') {
                showNotification('Tidak bisa mengontrol manual saat mode otomatis aktif!', 'warning');
                return;
            }
            
            const now = Date.now();
            if (lastControlTime[device] && now - lastControlTime[device] < 1000) {
                showNotification(`Tunggu sebentar sebelum mengontrol ${device} lagi`, 'warning');
                return;
            }
            lastControlTime[device] = now;
            
            disableControlButtons(device, true);
            
            const value = state === 'on' ? '1' : '0';
            let topic = '';
            
            if (device === 'pompa-isi') {
                topic = 'akuaponik/kendali/PompaIsi';
            } else if (device === 'pompa-buang') {
                topic = 'akuaponik/kendali/PompaBuang';
            } else if (device === 'irigasi') {
                topic = 'akuaponik/kendali/Irigasi';
            } else {
                topic = 'akuaponik/kendali/servo';
            }
            
            showControlLoading(device, true);
            
            client.publish(topic, value);
            
            const deviceNames = {
                'pompa-isi': 'Pompa Isi Air',
                'pompa-buang': 'Pompa Buang Air',
                'irigasi': 'Sistem Irigasi',
                'servo': 'Servo Pakan'
            };
            
            showNotification(`Mengirim perintah: ${deviceNames[device]} ${state === 'on' ? 'ON' : 'OFF'}`, 'info');
            
            setTimeout(() => {
                disableControlButtons(device, false);
                showControlLoading(device, false);
            }, 2000);
        }

        // ============================================
        // FUNGSI KALIBRASI
        // ============================================

        function setOffsetCalibration(type, buttonElement) {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mengkalibrasi', 'danger');
                return;
            }
            
            const inputId = `offset-${type}`;
            const input = document.getElementById(inputId);
            const offsetValue = input.value.trim();
            
            if (!offsetValue) {
                showNotification('Masukkan nilai offset terlebih dahulu', 'warning');
                return;
            }
            
            const offset = parseFloat(offsetValue);
            if (isNaN(offset)) {
                showNotification('Nilai offset harus berupa angka', 'warning');
                return;
            }
            
            const originalText = buttonElement.innerHTML;
            const originalClass = buttonElement.className;
            
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';
            
            setTimeout(() => {
                try {
                    const topic = offsetTopics[type];
                    if (!topic) {
                        throw new Error(`Topik untuk sensor ${type} tidak ditemukan`);
                    }
                    
                    client.publish(topic, offset.toString());
                    
                    lastCalibrationData[type] = {
                        sensor: sensorInfo[type].name,
                        offset: offset,
                        oldValue: currentSensorValues[type],
                        unit: sensorInfo[type].unit,
                        date: new Date().toLocaleString('id-ID')
                    };
                    
                    localStorage.setItem('lastCalibrationData', JSON.stringify(lastCalibrationData));
                    
                    updateCalibrationHistoryDisplay();
                    
                    input.value = '';
                    
                    showNotification(`Offset ${sensorInfo[type].name} diatur ke ${offset} ${sensorInfo[type].unit}`, 'success');
                    
                    buttonElement.innerHTML = '<i class="bi bi-check2-all me-2"></i>Berhasil';
                    buttonElement.className = 'btn btn-success';
                    
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.className = originalClass;
                        buttonElement.disabled = false;
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error setting offset:', error);
                    
                    buttonElement.innerHTML = '<i class="bi bi-x-circle me-2"></i>Gagal';
                    buttonElement.className = 'btn btn-outline-danger';
                    
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.className = originalClass;
                        buttonElement.disabled = false;
                    }, 2000);
                    
                    showNotification(`Gagal menyimpan offset: ${error.message}`, 'danger');
                }
            }, 1000);
        }

        function autoCalibrate(type) {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mengkalibrasi', 'danger');
                return;
            }
            
            const referenceInput = document.getElementById(`reference-${type}`);
            const referenceValue = parseFloat(referenceInput.value);
            
            if (isNaN(referenceValue)) {
                showNotification('Masukkan nilai referensi yang valid', 'warning');
                return;
            }
            
            const currentValue = currentSensorValues[type];
            const offset = (referenceValue - currentValue).toFixed(type === 'ph' ? 2 : 1);
            
            const offsetInput = document.getElementById(`offset-${type}`);
            offsetInput.value = offset;
            
            offsetInput.style.borderColor = '#28a745';
            offsetInput.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
            setTimeout(() => {
                offsetInput.style.borderColor = '';
                offsetInput.style.boxShadow = '';
            }, 2000);
            
            showNotification(
                `Auto-kalibrasi: Referensi ${referenceValue}${sensorInfo[type].unit} - Terbaca ${currentValue.toFixed(2)}${sensorInfo[type].unit} = Offset ${offset}${sensorInfo[type].unit}`,
                'info'
            );
        }

        function updateCalibrationHistoryDisplay() {
            const historyList = document.getElementById('history-list');
            const emptyHistory = document.getElementById('empty-history');
            
            if (!historyList || !emptyHistory) return;
            
            historyList.innerHTML = '';
            
            const hasHistory = Object.values(lastCalibrationData).some(entry => entry !== null);
            
            if (!hasHistory) {
                emptyHistory.style.display = 'block';
                return;
            }
            
            emptyHistory.style.display = 'none';
            
            Object.entries(lastCalibrationData).forEach(([type, entry]) => {
                if (entry) {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">${entry.sensor}</h6>
                            <small class="text-muted">${entry.date}</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Nilai Sebelum</small>
                                <div>${entry.oldValue} ${entry.unit}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Offset</small>
                                <div class="text-primary fw-bold">${entry.offset} ${entry.unit}</div>
                            </div>
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                }
            });
        }

        function resetCalibration() {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mereset kalibrasi', 'danger');
                return;
            }
            
            try {
                client.publish('akuaponik/kalibrasi/offset_air', '0');
                client.publish('akuaponik/kalibrasi/offset_ph', '0');
                client.publish('akuaponik/kalibrasi/offset_tds', '0');
                client.publish('akuaponik/kalibrasi/offset_turbidity', '0');
                client.publish('akuaponik/kalibrasi/offset_pakan', '0');
                
                lastCalibrationData = {
                    air: null,
                    ph: null,
                    tds: null,
                    turbidity: null,
                    feed: null
                };
                
                localStorage.setItem('lastCalibrationData', JSON.stringify(lastCalibrationData));
                
                const offsetInputs = ['air', 'ph', 'tds', 'turbidity', 'feed'];
                offsetInputs.forEach(type => {
                    const input = document.getElementById(`offset-${type}`);
                    if (input) input.value = '0';
                });
                
                document.getElementById('reference-air').value = '35.0';
                document.getElementById('reference-ph').value = '7.00';
                document.getElementById('reference-tds').value = '1000';
                document.getElementById('reference-turbidity').value = '0.0';
                document.getElementById('reference-feed').value = '25.0';
                
                updateCalibrationHistoryDisplay();
                
                showNotification('Semua kalibrasi telah direset ke nilai default (0)', 'warning');
                
            } catch (error) {
                console.error('Error resetting calibration:', error);
                showNotification('Gagal mereset kalibrasi: ' + error.message, 'danger');
            }
        }

        // ============================================
        // FUNGSI MODAL KONFIRMASI
        // ============================================

        let currentAction = null;

        function showConfirmModal(title, message, action) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            currentAction = action;
            
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function hideConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            currentAction = null;
        }

        function confirmAction() {
            if (currentAction) {
                currentAction();
            }
            hideConfirmModal();
        }

        function confirmSaveSettings() {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat menyimpan pengaturan', 'danger');
                return;
            }
            
            showConfirmModal(
                'Simpan Pengaturan',
                'Apakah Anda yakin ingin menyimpan semua pengaturan sistem?',
                saveSettings
            );
        }

        function confirmResetCalibration() {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mereset kalibrasi', 'danger');
                return;
            }
            
            showConfirmModal(
                'Reset Kalibrasi',
                'PERINGATAN: Semua offset kalibrasi akan dikembalikan ke nilai default (0).',
                resetCalibration
            );
        }

        function saveSettings() {
            try {
                const settings = {
                    interval: document.getElementById('data-interval').value,
                    warningWaterLow: document.getElementById('warning-water-low').value,
                    warningWaterHigh: document.getElementById('warning-water-high').value,
                    warningFeed: document.getElementById('warning-feed').value
                };
                
                if (parseFloat(settings.warningWaterLow) >= parseFloat(settings.warningWaterHigh)) {
                    showNotification('Threshold level air rendah harus lebih kecil dari threshold tinggi', 'warning');
                    return;
                }
                
                client.publish('akuaponik/pengaturan/interval', settings.interval);
                client.publish('akuaponik/pengaturan/warning_water_low', settings.warningWaterLow);
                client.publish('akuaponik/pengaturan/warning_water_high', settings.warningWaterHigh);
                client.publish('akuaponik/pengaturan/warning_feed', settings.warningFeed);
                
                showNotification('Pengaturan sistem berhasil disimpan', 'success');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Gagal menyimpan pengaturan', 'danger');
            }
        }

        // ============================================
        // INISIALISASI
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners untuk modal
            document.getElementById('confirm-action-btn').addEventListener('click', confirmAction);
            document.getElementById('cancel-btn').addEventListener('click', hideConfirmModal);
            
            document.getElementById('confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideConfirmModal();
                }
            });

            // Inisialisasi
            updateTime();
            setInterval(updateTime, 1000);
            
            document.querySelectorAll('input[id^="offset-"]').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const type = this.id.replace('offset-', '');
                        const button = this.parentElement.querySelector('button');
                        if (button) {
                            setOffsetCalibration(type, button);
                        }
                    }
                });
            });
            
            updateCalibrationHistoryDisplay();
            generateWaterAnimations();
            
            // Set initial values
            document.getElementById('ph-value').textContent = '7.2';
            document.getElementById('tds-value').textContent = '850';
            document.getElementById('turbidity-value').textContent = '12';
            document.getElementById('water-level').textContent = '35.0';
            document.getElementById('feed-level').textContent = '22.0';
            
            // Initialize visualizations
            updateWaterVisual(35, 63);
            updateFeedVisual(22, 29);
            updateWaterCondition();
            
            // Set slider to initial value
            document.getElementById('feed-amount-slider').value = currentFeedAmount;
            updateSliderLabels(currentFeedAmount);
            
            // Set initial control status
            updateControlStatusFromESP32('PompaIsi', false);
            updateControlStatusFromESP32('PompaBuang', false);
            updateControlStatusFromESP32('Irigasi', false);
            updateControlStatusFromESP32('Servo', false);
            
            // Set initial mode
            updateModeIndicator(true);
            updateESPStatus(false);
            
            // Load and display feeding history
            updateFeedingHistoryDisplay();
            
            // Start heartbeat checker
            startHeartbeatChecker();
            
            // Setup event listener untuk skip button
            const skipBtn = document.getElementById('skip-btn');
            if (skipBtn) {
                skipBtn.addEventListener('click', skipFeeding);
            }
            
            // Setup event listener untuk touch di mobile
            const servoIndicator = document.getElementById('servo-active-indicator');
            if (servoIndicator) {
                servoIndicator.addEventListener('touchmove', function(e) {
                    if (isServoActive) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Prevent accidental clicks on background
                servoIndicator.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });

        // ============================================
        // MQTT HANDLING
        // ============================================

        client.on('connect', () => {
            console.log('Dashboard terhubung ke broker MQTT');
            
            const statusDetail = document.getElementById('esp-status-detail');
            if (statusDetail) {
                statusDetail.textContent = 'Terhubung ke server, menunggu ESP32...';
            }
            
            const topics = [
                'akuaponik/monitoring/pH',
                'akuaponik/monitoring/TDS',
                'akuaponik/monitoring/Turbidity',
                'akuaponik/monitoring/Air',
                'akuaponik/monitoring/Pakan',
                'akuaponik/Status/Manual',
                'akuaponik/Status/Otomatis',
                'akuaponik/Status/PompaIsi',
                'akuaponik/Status/PompaBuang',
                'akuaponik/Status/Irigasi',
                'akuaponik/Status/Servo',
                'akuaponik/heartbeat'
            ];
            
            topics.forEach(topic => {
                client.subscribe(topic, (err) => {
                    if (err) {
                        console.error(`Gagal subscribe ke ${topic}:`, err);
                    }
                });
            });
        });

        client.on('message', (topic, message) => {
            const payload = message.toString();
            
            function animateValueChange(elementId, newValue) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const oldValue = parseFloat(element.textContent);
                const duration = 500;
                const steps = 20;
                const stepValue = (newValue - oldValue) / steps;
                let currentStep = 0;
                
                const interval = setInterval(() => {
                    if (currentStep >= steps) {
                        element.textContent = newValue;
                        clearInterval(interval);
                    } else {
                        const currentValue = oldValue + (stepValue * currentStep);
                        element.textContent = currentValue.toFixed(1);
                        currentStep++;
                    }
                }, duration / steps);
            }
            
            try {
                if (topic === 'akuaponik/monitoring/pH') {
                    const value = parseFloat(payload);
                    currentSensorValues.ph = value;
                    animateValueChange('ph-value', value);
                    document.getElementById('read-value-ph').textContent = `${value.toFixed(2)} pH`;
                    updateWaterCondition();
                } else if (topic === 'akuaponik/monitoring/TDS') {
                    const value = parseFloat(payload);
                    currentSensorValues.tds = value;
                    animateValueChange('tds-value', value);
                    document.getElementById('read-value-tds').textContent = `${value} ppm`;
                    updateWaterCondition();
                } else if (topic === 'akuaponik/monitoring/Turbidity') {
                    const value = parseFloat(payload);
                    currentSensorValues.turbidity = value;
                    animateValueChange('turbidity-value', value);
                    document.getElementById('read-value-turbidity').textContent = `${value.toFixed(1)} NTU`;
                    updateWaterCondition();
                } else if (topic === 'akuaponik/monitoring/Air') {
                    const value = parseFloat(payload);
                    currentSensorValues.air = value;
                    updateWaterVisual(value, 63);
                    document.getElementById('read-value-air').textContent = `${value.toFixed(1)} cm`;
                } else if (topic === 'akuaponik/monitoring/Pakan') {
                    const value = parseFloat(payload);
                    currentSensorValues.feed = value;
                    updateFeedVisual(value, 29);
                    document.getElementById('read-value-feed').textContent = `${value.toFixed(1)} cm`;
                } else if (topic.includes('Status/')) {
                    const device = topic.split('/').pop();
                    const isOn = payload === '1';
                    
                    updateControlStatusFromESP32(device, isOn);
                    
                    let deviceId = '';
                    if (device === 'PompaIsi') deviceId = 'pompa-isi';
                    else if (device === 'PompaBuang') deviceId = 'pompa-buang';
                    else if (device === 'Irigasi') deviceId = 'irigasi';
                    else if (device === 'Servo') deviceId = 'servo';
                    
                    if (deviceId) {
                        showControlLoading(deviceId, false);
                        disableControlButtons(deviceId, false);
                    }
                    
                    // UPDATE BAGIAN INI UNTUK SERVO:
                    if (device === 'Servo' && isOn) {
                        // Dapatkan durasi dari feed code
                        const durationMap = {
                            '1': 0.5,  // Sedikit
                            '2': 1.5,  // Sedang  
                            '3': 3.0   // Banyak
                        };
                        
                        const feedCode = getFeedCodeFromPercentage(currentFeedAmount);
                        const duration = durationMap[feedCode] || 1.5;
                        
                        // Tampilkan indicator setelah delay kecil
                        setTimeout(() => {
                            showServoActiveIndicator(duration);
                        }, 100);
                        
                    } else if (device === 'Servo' && !isOn) {
                        // Servo dimatikan
                        setTimeout(() => {
                            hideServoActiveIndicator(true);
                        }, 100);
                    }
                } else if (topic === 'akuaponik/heartbeat') {
                    const status = payload.toString();
                    if (status === 'ON') {
                        if (!espOnline) {
                            updateESPStatus(true);
                            showNotification('Sistem online - Kontrol diaktifkan', 'success');
                        }
                        lastHeartbeatTime = Date.now();
                    } else if (status === 'OFF') {
                        if (espOnline) {
                            updateESPStatus(false);
                            showNotification('ESP32 terputus - Sistem offline', 'danger');
                        }
                    }
                }
            } catch (error) {
                console.error('Error processing MQTT message:', error);
            }
        });

        client.on('error', (error) => {
            console.error('MQTT Error:', error);
            updateESPStatus(false);
        });

        client.on('disconnect', () => {
            console.log('Dashboard terputus dari broker MQTT');
            updateESPStatus(false);
        });

        document.getElementById('feed-amount-slider').addEventListener('input', function() {
            currentFeedAmount = this.value;
            updateSliderLabels(currentFeedAmount);
            
            if (espOnline) {
                const feedCode = getFeedCodeFromPercentage(currentFeedAmount);
                client.publish('akuaponik/pakan/durasi', feedCode);
            }
        });

        // Handle window resize untuk update animasi
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (isServoActive) {
                    const servoGear = document.querySelector('.servo-gear');
                    if (servoGear) {
                        if (window.innerWidth >= 768) {
                            // Switch ke animasi desktop (rotate)
                            servoGear.style.animation = 'gearRotate 3s linear infinite';
                        } else {
                            // Switch ke animasi mobile (pulse)
                            servoGear.style.animation = 'gearPulse 2s infinite';
                        }
                    }
                }
            }, 250);
        });

        // Handle ESC key untuk skip feeding
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isServoActive) {
                skipFeeding();
            }
        });
    </script>
</body>
</html>
