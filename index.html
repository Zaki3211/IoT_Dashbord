<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Dashboard IoT Akuaponik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-blue: #1a73e8;
            --aqua-green: #00c9b7;
            --water-blue: #4fc3f7;
            --plant-green: #81c784;
            --fish-orange: #ff8a65;
            --warning-red: #ff5252;
            --safe-green: #4caf50;
            --control-blue: #2196f3;
            --control-red: #f44336;
            --auto-color: #4caf50;
            --manual-color: #ff9800;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-top: 20px;
            overflow-x: hidden;
        }

        /* Responsive padding untuk container */
        .container {
            padding-left: 15px;
            padding-right: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            body {
                padding-top: 10px;
            }
        }

        .dashboard-header {
            background: linear-gradient(90deg, var(--primary-blue), var(--aqua-green));
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(26, 115, 232, 0.2);
            animation: slideInDown 0.8s ease-out;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 10px;
            }
            .dashboard-header h1 {
                font-size: 1.8rem !important;
            }
            .dashboard-header .lead {
                font-size: 0.9rem;
            }
        }

        /* Status Indicators Positioning Responsive */
        .status-container {
            position: fixed;
            top: 20px;
            z-index: 1000;
        }

        .esp-status-container {
            left: 20px;
            width: 280px;
        }

        .mode-indicator-container {
            right: 20px;
        }

        @media (max-width: 768px) {
            .status-container {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .esp-status-container {
                width: 100%;
                left: 0;
                padding: 0 10px;
            }
            
            .mode-indicator-container {
                width: 100%;
                right: 0;
                padding: 0 10px;
                margin-top: 10px;
            }
            
            .esp-status-card {
                width: 100%;
            }
            
            .mode-indicator {
                width: 100%;
                text-align: center;
                font-size: 0.8rem;
                padding: 8px 15px;
            }
        }

        /* ESP Status Card */
        .esp-status-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #6c757d;
            transition: all 0.3s;
        }

        .esp-status-card.online {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f0fff4, #e6ffed);
        }

        .esp-status-card.offline {
            border-left: 4px solid #dc3545;
            background: linear-gradient(135deg, #fff5f5, #ffe5e5);
            animation: pulseWarning 2s infinite;
        }

        .esp-status-indicator {
            font-size: 1.5rem;
            color: #6c757d;
        }

        .esp-status-indicator.online {
            color: #28a745;
            animation: pulse 2s infinite;
        }

        .esp-status-indicator.offline {
            color: #dc3545;
        }

        /* Mode Indicator */
        .mode-indicator {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
            text-transform: uppercase;
        }

        .mode-auto {
            background: linear-gradient(90deg, var(--auto-color), #66bb6a);
            color: white;
        }

        .mode-manual {
            background: linear-gradient(90deg, var(--manual-color), #ffb74d);
            color: white;
        }

        @keyframes pulseWarning {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        /* ESP Offline Overlay Responsive */
        .esp-offline-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9997;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            padding: 20px;
        }

        .esp-offline-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .esp-offline-message {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideInDown 0.5s ease-out;
        }

        @media (max-width: 768px) {
            .esp-offline-message {
                padding: 1.5rem;
                margin: 0 10px;
            }
            .esp-offline-message h3 {
                font-size: 1.5rem;
            }
        }

        /* Navigation Tabs Responsive */
        .nav-tabs-custom {
            border-bottom: none;
            margin-bottom: 2rem;
        }

        .nav-tabs-custom .nav-link {
            color: #666;
            border: none;
            border-radius: 50px;
            padding: 0.75rem 2rem;
            margin: 0 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-tabs-custom .nav-link i {
            margin-right: 8px;
        }

        .nav-tabs-custom .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-tabs-custom .nav-link.active {
            background: linear-gradient(90deg, var(--primary-blue), var(--aqua-green));
            color: white;
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
            border: none;
        }

        @media (max-width: 768px) {
            .nav-tabs-custom {
                margin-bottom: 1rem;
            }
            .nav-tabs-custom .nav-link {
                padding: 0.5rem 1rem;
                margin: 0 5px;
                font-size: 0.9rem;
            }
            .nav-tabs-custom .nav-link i {
                margin-right: 5px;
            }
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .content-section.active {
            display: block;
        }

        /* Servo Active Indicator Responsive */
        .servo-active-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 2000;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 152, 0, 0.5);
            animation: servoIndicatorAppear 0.5s ease-out forwards;
            display: none;
            max-width: 400px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .servo-active-indicator {
                padding: 20px;
                width: 85%;
            }
            .servo-gear {
                font-size: 3rem !important;
            }
            .servo-progress-ring {
                width: 100px !important;
                height: 100px !important;
            }
            .feeding-time {
                font-size: 1.5rem !important;
            }
        }

        .servo-active-content {
            position: relative;
            padding: 20px;
        }

        .servo-gear {
            font-size: 4rem;
            margin-bottom: 20px;
            display: inline-block;
            color: white;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .servo-gear.rotating {
            animation: rotate 2s linear infinite;
        }

        .servo-pulse {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: rgba(255, 152, 0, 0.2);
            animation: pulseRing 2s infinite;
            transform: scale(1);
        }

        .servo-progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }

        .servo-progress-ring-circle {
            width: 100%;
            height: 100%;
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .servo-progress-ring-bg {
            stroke: rgba(255, 255, 255, 0.2);
        }

        .servo-progress-ring-fill {
            stroke: white;
            stroke-dasharray: 314;
            stroke-dashoffset: 314;
            transition: stroke-dashoffset 0.3s linear;
        }

        .feeding-time {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .feeding-description {
            font-size: 1.1rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .feeding-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .feeding-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: floatParticle 3s ease-out forwards;
        }

        /* Card Responsive */
        .card {
            border: none;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out;
        }

        @media (max-width: 768px) {
            .card {
                border-radius: 10px;
                margin-bottom: 1rem;
            }
            .card-header {
                padding: 0.75rem 1rem !important;
            }
            .card-header h4 {
                font-size: 1.1rem;
            }
            .card-body {
                padding: 1rem;
            }
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(90deg, var(--primary-blue), var(--aqua-green));
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem 1.5rem;
        }

        /* Water Tank Animation Responsive */
        .water-tank-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .water-tank-container {
                height: 200px;
            }
        }

        .water-tank {
            position: absolute;
            width: 200px;
            height: 250px;
            left: 50%;
            transform: translateX(-50%);
            border: 3px solid var(--water-blue);
            border-radius: 10px;
            background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .water-tank {
                width: 150px;
                height: 200px;
            }
        }

        .water-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, var(--water-blue), #29b6f6);
            transition: height 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 0 0 7px 7px;
        }

        .fish {
            position: absolute;
            width: 30px;
            height: 15px;
            background: var(--fish-orange);
            border-radius: 50%;
            animation: swim 8s infinite linear;
        }

        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: bubbleRise 4s infinite linear;
        }

        /* Feed Container Responsive */
        .feed-container {
            position: relative;
            width: 120px;
            height: 200px;
            margin: 0 auto;
            border: 3px solid #8d6e63;
            border-radius: 10px;
            background: linear-gradient(to bottom, #efebe9, #d7ccc8);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .feed-container {
                width: 100px;
                height: 150px;
            }
        }

        .feed-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #8d6e63, #a1887f);
            transition: height 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 0 0 7px 7px;
        }

        /* Sensor Cards Responsive */
        .sensor-card {
            border-left: 5px solid;
            padding: 15px;
            border-radius: 10px;
            background: white;
            transition: all 0.3s;
            height: 100%;
        }

        @media (max-width: 768px) {
            .sensor-card {
                padding: 12px;
                margin-bottom: 10px;
            }
            .sensor-card .value-display {
                font-size: 1.8rem !important;
            }
            .sensor-card i {
                font-size: 2rem !important;
            }
        }

        .sensor-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .sensor-card.ph { border-color: #9c27b0; }
        .sensor-card.tds { border-color: #2196f3; }
        .sensor-card.turbidity { border-color: #ff9800; }

        .value-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .value-unit {
            font-size: 1.2rem;
            color: #666;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .value-display {
                font-size: 1.8rem;
            }
            .value-unit {
                font-size: 1rem;
            }
        }

        /* Control Cards Responsive */
        .control-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .control-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            .control-card h5 {
                font-size: 1rem;
            }
            .control-icon {
                font-size: 2.5rem !important;
            }
        }

        .control-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .control-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: statusPulse 2s infinite;
        }

        .status-on { 
            background: var(--safe-green); 
            animation: statusPulse 2s infinite;
        }
        .status-off { 
            background: var(--warning-red); 
            animation: none;
        }
        .status-loading { 
            background: #ff9800; 
            animation: pulse 1s infinite;
        }

        .control-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary-blue);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .control-buttons {
                gap: 8px;
            }
            .control-btn {
                padding: 8px 5px;
                font-size: 0.85rem;
            }
        }

        .control-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
        }

        .btn-on {
            background: linear-gradient(135deg, var(--safe-green), #66bb6a);
            color: white;
        }

        .btn-off {
            background: linear-gradient(135deg, var(--warning-red), #ef5350);
            color: white;
        }

        .control-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Feed Management Card Responsive */
        .feed-management-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            height: 100%;
        }

        @media (max-width: 768px) {
            .feed-management-card {
                padding: 15px;
            }
        }

        .feed-management-card.feeding-active {
            animation: cardPulse 1.5s infinite;
            border: 2px solid #ff9800;
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
        }

        .slider-container {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .slider-container {
                padding: 15px;
                margin: 15px 0;
            }
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 0 10px;
        }

        .slider-label {
            font-weight: 600;
            color: #666;
            padding: 5px 10px;
            border-radius: 20px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .slider-label {
                font-size: 0.8rem;
                padding: 4px 8px;
            }
        }

        .slider-label.active {
            background: var(--aqua-green);
            color: white;
            transform: scale(1.1);
        }

        /* Custom Slider Responsive */
        .custom-slider {
            appearance: none;
            -moz-appearance: none;
            -webkit-appearance: none;
            width: 100%;
            height: 20px;
            border-radius: 10px;
            background: linear-gradient(to right, #81c784, #4caf50, #388e3c);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }

        @media (max-width: 768px) {
            .custom-slider {
                height: 16px;
            }
            .custom-slider::-webkit-slider-thumb {
                width: 35px !important;
                height: 35px !important;
            }
        }

        .custom-slider:hover {
            opacity: 1;
        }

        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--aqua-green);
            cursor: pointer;
            border: 4px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .custom-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }

        .custom-slider::-moz-range-thumb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--aqua-green);
            cursor: pointer;
            border: 4px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        /* Calibration Styles Responsive */
        .calibration-step {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--aqua-green);
        }

        @media (max-width: 768px) {
            .calibration-step {
                padding: 15px;
                margin-bottom: 15px;
            }
            .calibration-step h5 {
                font-size: 1.1rem;
            }
        }

        .calibration-step.active {
            background: #e8f4fd;
            border-left: 4px solid var(--primary-blue);
        }

        .calibration-step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: var(--aqua-green);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: bold;
            margin-right: 15px;
        }

        @media (max-width: 768px) {
            .calibration-step-number {
                width: 35px;
                height: 35px;
                line-height: 35px;
                font-size: 0.9rem;
                margin-right: 10px;
            }
        }

        .calibration-step.active .calibration-step-number {
            background: var(--primary-blue);
        }

        .auto-calibration {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .auto-calibration {
                padding: 12px;
            }
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-blue);
        }

        @media (max-width: 768px) {
            .history-item {
                padding: 12px;
            }
        }

        /* Modal Confirm Responsive */
        .modal-confirm {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .modal-content-confirm {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideInDown 0.3s ease-out;
            position: relative;
            z-index: 10000;
        }

        @media (max-width: 768px) {
            .modal-content-confirm {
                padding: 20px;
            }
        }

        /* Input fields responsive */
        input.form-control {
            min-height: 45px;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            input.form-control {
                min-height: 40px;
                font-size: 0.95rem;
            }
            .input-group {
                flex-wrap: wrap;
            }
            .input-group .btn {
                margin-top: 5px;
                width: 100%;
            }
        }

        /* Button sizes untuk mobile */
        @media (max-width: 768px) {
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            .btn-lg {
                padding: 0.6rem 1.2rem;
                font-size: 1rem;
            }
        }

        /* Mode Selection Buttons Responsive */
        @media (max-width: 768px) {
            .control-btn.btn {
                padding: 1rem 0.5rem;
                font-size: 0.9rem;
            }
            .control-btn.btn .fs-4 {
                font-size: 1.5rem !important;
            }
        }

        /* Plant Growth Responsive */
        .plant-growth {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 100px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .plant-growth {
                height: 80px;
                margin-top: 15px;
            }
            .plant {
                width: 20px !important;
            }
        }

        .plant {
            width: 25px;
            height: 0;
            background: var(--plant-green);
            margin: 0 5px;
            border-radius: 15px 15px 0 0;
            position: relative;
            overflow: hidden;
            animation: growPlant 2s ease-out forwards;
        }

        .plant::after {
            content: '';
            position: absolute;
            top: -10px;
            left: 5px;
            right: 5px;
            height: 10px;
            background: var(--plant-green);
            border-radius: 50%;
        }

        /* Grid system responsive adjustments */
        @media (max-width: 768px) {
            .row {
                margin-left: -8px;
                margin-right: -8px;
            }
            .col, .col-auto, .col-1, .col-2, .col-3, .col-4, .col-5, .col-6,
            .col-7, .col-8, .col-9, .col-10, .col-11, .col-12,
            .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6,
            .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12,
            .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6,
            .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12 {
                padding-left: 8px;
                padding-right: 8px;
            }
        }

        /* Animations */
        @keyframes swim {
            0% { transform: translateX(-30px) rotateY(0); }
            25% { transform: translateX(calc(50% - 15px)) rotateY(0); }
            26% { transform: translateX(calc(50% - 15px)) rotateY(180deg); }
            75% { transform: translateX(calc(100% - 15px)) rotateY(180deg); }
            76% { transform: translateX(calc(100% - 15px)) rotateY(0); }
            100% { transform: translateX(-30px) rotateY(0); }
        }

        @keyframes bubbleRise {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-200px) scale(1.2);
                opacity: 0;
            }
        }

        @keyframes statusPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes servoIndicatorAppear {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            70% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes servoIndicatorDisappear {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
        }

        @keyframes pulseRing {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        @keyframes floatParticle {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(var(--tx)) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes cardPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 152, 0, 0.5);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .quality-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .good { background: var(--safe-green); }
        .warning { background: #ffc107; }
        .danger { background: var(--warning-red); }

        .water-drop {
            width: 20px;
            height: 20px;
            background: var(--water-blue);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: inline-block;
            margin-right: 10px;
            animation: dropFall 2s infinite;
        }

        @keyframes dropFall {
            0% { transform: translateY(-20px) rotate(-45deg) scale(0.8); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(20px) rotate(-45deg) scale(1); opacity: 0; }
        }

        @keyframes growPlant {
            from { height: 0; }
            to { height: var(--height); }
        }

        .sensor-progress {
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            margin-top: 10px;
            overflow: hidden;
        }

        .sensor-progress-bar {
            height: 100%;
            transition: width 1s ease;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
            max-width: 350px;
        }

        @media (max-width: 768px) {
            .notification {
                left: 10px;
                right: 10px;
                bottom: 10px;
                max-width: 100%;
            }
        }

        .feed-animation {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .feed-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff9800;
            border-radius: 50%;
            animation: feedDrop 1s linear forwards;
        }

        @keyframes feedDrop {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(100px) scale(0.5);
                opacity: 0;
            }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Touch-friendly improvements */
        @media (max-width: 768px) {
            button, .btn, .control-btn, .nav-link {
                min-height: 44px;
                min-width: 44px;
            }
            
            input, select, textarea {
                font-size: 16px !important; /* Mencegah zoom di iOS */
            }
        }

        /* Hide unnecessary elements on mobile */
        @media (max-width: 576px) {
            .text-end {
                text-align: center !important;
                margin-top: 10px;
            }
            
            .plant-growth {
                display: none;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- ESP Offline Overlay -->
    <div class="esp-offline-overlay" id="esp-offline-overlay">
        <div class="esp-offline-message">
            <i class="bi bi-wifi-off display-1 text-danger mb-3"></i>
            <h3 class="text-danger">SISTEM OFFLINE</h3>
            <p class="text-muted">ESP32 tidak terdeteksi atau terputus</p>
            <p>Semua kontrol dinonaktifkan sampai sistem kembali online</p>
            <div class="mt-3">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                <small>Menunggu koneksi...</small>
            </div>
        </div>
    </div>

    <!-- Status Containers untuk Mobile -->
    <div class="d-block d-md-none">
        <!-- ESP Status Indicator (Mobile) -->
        <div class="status-container esp-status-container">
            <div class="card esp-status-card" id="esp-status-card">
                <div class="card-body p-2">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="esp-status-indicator" id="esp-status-indicator">
                                <i class="bi bi-wifi"></i>
                            </div>
                        </div>
                        <div class="col">
                            <h6 class="mb-0" id="esp-status-title">Status Sistem</h6>
                            <small class="text-muted" id="esp-status-text">
                                <span id="esp-status-detail">Menghubungkan ke ESP32...</span>
                            </small>
                        </div>
                        <div class="col-auto">
                            <div id="esp-status-badge">
                                <span class="badge bg-secondary" id="esp-status-badge-text">OFFLINE</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode Indicator (Mobile) -->
        <div class="status-container mode-indicator-container">
            <div class="mode-indicator mode-auto" id="mode-indicator">
                <i class="bi bi-robot"></i> MODE OTOMATIS
            </div>
        </div>
    </div>

    <!-- Status Containers untuk Desktop -->
    <div class="d-none d-md-block">
        <!-- ESP Status Indicator (Desktop) -->
        <div class="status-container esp-status-container">
            <div class="card esp-status-card" id="esp-status-card-desktop">
                <div class="card-body p-2">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="esp-status-indicator" id="esp-status-indicator-desktop">
                                <i class="bi bi-wifi"></i>
                            </div>
                        </div>
                        <div class="col">
                            <h6 class="mb-0" id="esp-status-title-desktop">Status Sistem</h6>
                            <small class="text-muted" id="esp-status-text-desktop">
                                <span id="esp-status-detail-desktop">Menghubungkan ke ESP32...</span>
                            </small>
                        </div>
                        <div class="col-auto">
                            <div id="esp-status-badge-desktop">
                                <span class="badge bg-secondary" id="esp-status-badge-text-desktop">OFFLINE</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode Indicator (Desktop) -->
        <div class="status-container mode-indicator-container">
            <div class="mode-indicator mode-auto" id="mode-indicator-desktop">
                <i class="bi bi-robot"></i> MODE OTOMATIS
            </div>
        </div>
    </div>

    <!-- Servo Active Indicator -->
    <div class="servo-active-indicator" id="servo-active-indicator">
        <div class="servo-active-content">
            <div class="servo-progress-ring">
                <svg class="servo-progress-ring-circle">
                    <circle class="servo-progress-ring-bg" cx="60" cy="60" r="50"></circle>
                    <circle class="servo-progress-ring-fill" cx="60" cy="60" r="50" id="servo-progress-circle"></circle>
                </svg>
                <i class="bi bi-gear-fill servo-gear rotating"></i>
                <div class="servo-pulse"></div>
            </div>
            <div class="feeding-time" id="feeding-time">3.0s</div>
            <div class="feeding-description">Servo pakan sedang aktif</div>
            <div class="feeding-particles" id="feeding-particles"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-confirm" id="confirm-modal">
        <div class="modal-content-confirm">
            <div class="text-center mb-4">
                <i class="bi bi-question-circle display-1 text-primary"></i>
            </div>
            <h4 class="text-center mb-3" id="confirm-title">Konfirmasi</h4>
            <p class="text-center text-muted mb-4" id="confirm-message"></p>
            <div class="d-flex gap-3 flex-column flex-md-row">
                <button class="btn btn-outline-secondary flex-fill" id="cancel-btn">
                    <i class="bi bi-x-lg"></i> Batal
                </button>
                <button class="btn btn-primary flex-fill" id="confirm-action-btn">
                    <i class="bi bi-check-lg"></i> Ya, Lanjutkan
                </button>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Header -->
        <div class="dashboard-header animate__animated animate__fadeIn">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold"><i class="bi bi-droplet-half"></i> Smart Aquaponics Dashboard</h1>
                    <p class="lead mb-0">Sistem Monitoring dan Kontrol Akuaponik Terintegrasi IoT</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-inline-block p-3 rounded-3" style="background: rgba(255,255,255,0.2);">
                        <div id="current-time" class="h4 mb-0"></div>
                        <small>Waktu Sistem</small>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs-custom mt-3">
                <ul class="nav nav-tabs justify-content-center" id="mainTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="monitoring-tab" onclick="switchTab('monitoring')">
                            <i class="bi bi-graph-up"></i> <span class="d-none d-md-inline">Monitoring & Kontrol</span>
                            <span class="d-inline d-md-none">Monitoring</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="calibration-tab" onclick="switchTab('calibration')">
                            <i class="bi bi-tools"></i> <span class="d-none d-md-inline">Kalibrasi</span>
                            <span class="d-inline d-md-none">Kalibrasi</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div id="monitoring-section" class="content-section active">
            <!-- Water Quality Monitoring -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h4 class="mb-0"><i class="bi bi-water"></i> Kualitas Air</h4>
                            <div class="d-none d-md-block">
                                <span class="quality-indicator good"></span>
                                <small>Kondisi: <span id="water-condition">Baik</span></small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Water Tank with Animation -->
                                <div class="col-md-4 text-center mb-3 mb-md-0">
                                    <div class="water-tank-container mb-3">
                                        <div class="water-tank">
                                            <div class="water-level" id="water-level-visual"></div>
                                            <!-- Fish will be added by JavaScript -->
                                        </div>
                                    </div>
                                    <div class="water-drop"></div>
                                    <h3 class="value-display d-inline" id="water-level">0</h3>
                                    <span class="value-unit">cm</span>
                                    <p class="text-muted mt-2">Level Air Kolam Ikan</p>
                                </div>

                                <!-- Sensor Readings -->
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="sensor-card ph">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="text-uppercase text-muted mb-1">pH Air</h6>
                                                        <h2 class="value-display" id="ph-value">7.0</h2>
                                                        <small class="text-muted">Optimal: 6.5-7.5</small>
                                                    </div>
                                                    <i class="bi bi-droplet fs-1" style="color: #9c27b0;"></i>
                                                </div>
                                                <div class="sensor-progress">
                                                    <div id="ph-progress" class="sensor-progress-bar" style="width: 50%; background: #9c27b0;"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4 mb-3">
                                            <div class="sensor-card tds">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="text-uppercase text-muted mb-1">TDS</h6>
                                                        <h2 class="value-display d-inline" id="tds-value">800</h2>
                                                        <span class="value-unit">ppm</span>
                                                        <small class="text-muted d-block mt-1">Total Dissolved Solids</small>
                                                    </div>
                                                    <i class="bi bi-speedometer2 fs-1" style="color: #2196f3;"></i>
                                                </div>
                                                <div class="sensor-progress">
                                                    <div id="tds-progress" class="sensor-progress-bar" style="width: 60%; background: #2196f3;"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4 mb-3">
                                            <div class="sensor-card turbidity">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="text-uppercase text-muted mb-1">Kekeruhan</h6>
                                                        <h2 class="value-display d-inline" id="turbidity-value">15</h2>
                                                        <span class="value-unit">NTU</span>
                                                        <small class="text-muted d-block mt-1">Kejernihan Air</small>
                                                    </div>
                                                    <i class="bi bi-cloud-fog fs-1" style="color: #ff9800;"></i>
                                                </div>
                                                <div class="sensor-progress">
                                                    <div id="turbidity-progress" class="sensor-progress-bar" style="width: 30%; background: #ff9800;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Plant Growth Animation -->
                                    <div class="plant-growth d-none d-md-flex">
                                        <div class="plant" style="--height: 60px; animation-delay: 0.2s;"></div>
                                        <div class="plant" style="--height: 80px; animation-delay: 0.4s;"></div>
                                        <div class="plant" style="--height: 40px; animation-delay: 0.6s;"></div>
                                        <div class="plant" style="--height: 70px; animation-delay: 0.8s;"></div>
                                        <div class="plant" style="--height: 50px; animation-delay: 1s;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feed Stock -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-bucket"></i> Stok Pakan</h4>
                        </div>
                        <div class="card-body text-center">
                            <div class="feed-container mb-3">
                                <div class="feed-level" id="feed-level-visual"></div>
                                <div class="feed-animation" id="feed-animation"></div>
                            </div>
                            <h2 class="value-display" id="feed-level">25</h2>
                            <span class="value-unit">cm</span>
                            <p class="text-muted mt-2">Sisa Stok Pakan</p>
                            
                            <div class="mt-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Kapasitas</span>
                                    <span id="feed-percentage">85%</span>
                                </div>
                                <div class="progress" style="height: 15px; border-radius: 10px;">
                                    <div id="feed-progress-bar" class="progress-bar bg-success" style="width: 85%;"></div>
                                </div>
                            </div>

                            <div class="alert alert-warning mt-3 animate__animated animate__pulse" id="feed-alert" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i> Stok pakan hampir habis!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Control with Status Indicators -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-sliders"></i> Kontrol Sistem</h4>
                        </div>
                        <div class="card-body">
                            <!-- Mode Selection Buttons -->
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <button class="control-btn btn btn-success w-100 py-3" onclick="setMode('auto')" id="btn-mode-auto">
                                        <i class="bi bi-robot fs-4"></i>
                                        <div class="mt-2">Mode Otomatis</div>
                                        <small class="d-none d-md-block">Sistem berjalan sendiri berdasarkan sensor</small>
                                    </button>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <button class="control-btn btn btn-warning w-100 py-3" onclick="setMode('manual')" id="btn-mode-manual">
                                        <i class="bi bi-hand-index fs-4"></i>
                                        <div class="mt-2">Mode Manual</div>
                                        <small class="d-none d-md-block">Kontrol manual semua perangkat</small>
                                    </button>
                                </div>
                            </div>

                            <!-- Control Cards with Status on Top -->
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="control-card">
                                        <div class="control-status status-off" id="pompa-isi-status-indicator"></div>
                                        <i class="bi bi-droplet control-icon"></i>
                                        <h5>Pompa Isi Air</h5>
                                        <p class="text-muted small d-none d-md-block">Mengisi air ke kolam ikan</p>
                                        <div class="control-buttons">
                                            <button class="control-btn btn-on" onclick="controlDevice('pompa-isi', 'on')" id="btn-pompa-isi-on">
                                                <i class="bi bi-play-fill"></i> ON
                                            </button>
                                            <button class="control-btn btn-off" onclick="controlDevice('pompa-isi', 'off')" id="btn-pompa-isi-off">
                                                <i class="bi bi-stop-fill"></i> OFF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <div class="control-card">
                                        <div class="control-status status-off" id="pompa-buang-status-indicator"></div>
                                        <i class="bi bi-droplet-fill control-icon"></i>
                                        <h5>Pompa Buang Air</h5>
                                        <p class="text-muted small d-none d-md-block">Menguras air dari kolam</p>
                                        <div class="control-buttons">
                                            <button class="control-btn btn-on" onclick="controlDevice('pompa-buang', 'on')" id="btn-pompa-buang-on">
                                                <i class="bi bi-play-fill"></i> ON
                                            </button>
                                            <button class="control-btn btn-off" onclick="controlDevice('pompa-buang', 'off')" id="btn-pompa-buang-off">
                                                <i class="bi bi-stop-fill"></i> OFF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <div class="control-card">
                                        <div class="control-status status-off" id="irigasi-status-indicator"></div>
                                        <i class="bi bi-droplet control-icon"></i>
                                        <h5>Sistem Irigasi</h5>
                                        <p class="text-muted small d-none d-md-block">Mengairi tanaman hidroponik</p>
                                        <div class="control-buttons">
                                            <button class="control-btn btn-on" onclick="controlDevice('irigasi', 'on')" id="btn-irigasi-on">
                                                <i class="bi bi-play-fill"></i> ON
                                            </button>
                                            <button class="control-btn btn-off" onclick="controlDevice('irigasi', 'off')" id="btn-irigasi-off">
                                                <i class="bi bi-stop-fill"></i> OFF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Feed Control Card dengan Slider -->
                                <div class="col-md-3 mb-3">
                                    <div class="feed-management-card" id="feed-control-card">
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">Kontrol Pakan</h5>
                                                    <div class="control-status status-off" id="servo-status-indicator"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-12">
                                                <button class="control-btn btn-on w-100 mb-3" onclick="feedNow()" id="feed-now-btn">
                                                    <i class="bi bi-bucket-fill"></i> BERI PAKAN
                                                </button>
                                            </div>

                                            <!-- Slider untuk Jumlah Pakan -->
                                            <div class="col-12">
                                                <div class="slider-container">
                                                    <h6 class="mb-3">Jumlah Pakan:</h6>
                                                    <input type="range" min="1" max="100" value="50" class="custom-slider" id="feed-amount-slider">
                                                    
                                                    <div class="slider-labels">
                                                        <span class="slider-label" id="label-sedikit">Sedikit</span>
                                                        <span class="slider-label active" id="label-sedang">Sedang</span>
                                                        <span class="slider-label" id="label-banyak">Banyak</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calibration Section -->
        <div id="calibration-section" class="content-section">
            <div class="row">
                <!-- Calibration Controls -->
                <div class="col-md-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-sliders"></i> Kalibrasi Offset Sensor</h4>
                        </div>
                        <div class="card-body">
                            <!-- Level Air -->
                            <div class="calibration-step active" id="step-air">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="calibration-step-number">1</span>
                                    <h5 class="mb-0">Kalibrasi Level Air</h5>
                                </div>
                                <p class="text-muted mb-3">Atur offset untuk kalibrasi sensor level air.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nilai Terbaca: <span class="fw-bold" id="read-value-air">35.0 cm</span></label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">Offset (cm)</span>
                                        <input type="number" class="form-control" id="offset-air" step="0.1" placeholder="0.0">
                                        <button class="btn btn-outline-primary" onclick="setOffsetCalibration('air', this)">
                                            <i class="bi bi-check-lg"></i> Terapkan
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="auto-calibration">
                                    <h6><i class="bi bi-robot"></i> Auto Kalibrasi</h6>
                                    <p class="text-muted small">Masukkan nilai referensi aktual untuk kalibrasi otomatis.</p>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Nilai Referensi</span>
                                        <input type="number" class="form-control" id="reference-air" step="0.1" value="35.0">
                                        <button class="btn btn-success" onclick="autoCalibrate('air')">
                                            <i class="bi bi-gear"></i> Auto Kalibrasi
                                        </button>
                                    </div>
                                    <small class="text-muted">Sistem akan menghitung offset otomatis berdasarkan nilai referensi.</small>
                                </div>
                            </div>

                            <!-- pH -->
                            <div class="calibration-step" id="step-ph">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="calibration-step-number">2</span>
                                    <h5 class="mb-0">Kalibrasi pH Meter</h5>
                                </div>
                                <p class="text-muted mb-3">Atur offset untuk kalibrasi sensor pH.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nilai Terbaca: <span class="fw-bold" id="read-value-ph">7.2 pH</span></label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">Offset (pH)</span>
                                        <input type="number" class="form-control" id="offset-ph" step="0.01" placeholder="0.00">
                                        <button class="btn btn-outline-primary" onclick="setOffsetCalibration('ph', this)">
                                            <i class="bi bi-check-lg"></i> Terapkan
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="auto-calibration">
                                    <h6><i class="bi bi-robot"></i> Auto Kalibrasi</h6>
                                    <p class="text-muted small">Masukkan nilai referensi aktual untuk kalibrasi otomatis.</p>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Nilai Referensi</span>
                                        <input type="number" class="form-control" id="reference-ph" step="0.01" value="7.00">
                                        <button class="btn btn-success" onclick="autoCalibrate('ph')">
                                            <i class="bi bi-gear"></i> Auto Kalibrasi
                                        </button>
                                    </div>
                                    <small class="text-muted">Gunakan larutan buffer pH 4.0, 7.0, atau 10.0 sebagai referensi.</small>
                                </div>
                            </div>

                            <!-- TDS -->
                            <div class="calibration-step" id="step-tds">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="calibration-step-number">3</span>
                                    <h5 class="mb-0">Kalibrasi TDS</h5>
                                </div>
                                <p class="text-muted mb-3">Atur offset untuk kalibrasi sensor TDS.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nilai Terbaca: <span class="fw-bold" id="read-value-tds">850 ppm</span></label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">Offset (ppm)</span>
                                        <input type="number" class="form-control" id="offset-tds" step="1" placeholder="0">
                                        <button class="btn btn-outline-primary" onclick="setOffsetCalibration('tds', this)">
                                            <i class="bi bi-check-lg"></i> Terapkan
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="auto-calibration">
                                    <h6><i class="bi bi-robot"></i> Auto Kalibrasi</h6>
                                    <p class="text-muted small">Masukkan nilai referensi aktual untuk kalibrasi otomatis.</p>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Nilai Referensi</span>
                                        <input type="number" class="form-control" id="reference-tds" step="1" value="1000">
                                        <button class="btn btn-success" onclick="autoCalibrate('tds')">
                                            <i class="bi bi-gear"></i> Auto Kalibrasi
                                        </button>
                                    </div>
                                    <small class="text-muted">Gunakan larutan kalibrasi 1413 S/cm atau 1000 ppm sebagai referensi.</small>
                                </div>
                            </div>

                            <!-- Turbidity -->
                            <div class="calibration-step" id="step-turbidity">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="calibration-step-number">4</span>
                                    <h5 class="mb-0">Kalibrasi Sensor Kekeruhan</h5>
                                </div>
                                <p class="text-muted mb-3">Atur offset untuk kalibrasi sensor kekeruhan.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nilai Terbaca: <span class="fw-bold" id="read-value-turbidity">12.5 NTU</span></label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">Offset (NTU)</span>
                                        <input type="number" class="form-control" id="offset-turbidity" step="0.1" placeholder="0.0">
                                        <button class="btn btn-outline-primary" onclick="setOffsetCalibration('turbidity', this)">
                                            <i class="bi bi-check-lg"></i> Terapkan
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="auto-calibration">
                                    <h6><i class="bi bi-robot"></i> Auto Kalibrasi</h6>
                                    <p class="text-muted small">Masukkan nilai referensi aktual untuk kalibrasi otomatis.</p>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Nilai Referensi</span>
                                        <input type="number" class="form-control" id="reference-turbidity" step="0.1" value="0.0">
                                        <button class="btn btn-success" onclick="autoCalibrate('turbidity')">
                                            <i class="bi bi-gear"></i> Auto Kalibrasi
                                        </button>
                                    </div>
                                    <small class="text-muted">Gunakan air jernih (0 NTU) atau larutan standar sebagai referensi.</small>
                                </div>
                            </div>

                            <!-- Level Pakan -->
                            <div class="calibration-step" id="step-feed">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="calibration-step-number">5</span>
                                    <h5 class="mb-0">Kalibrasi Level Pakan</h5>
                                </div>
                                <p class="text-muted mb-3">Atur offset untuk kalibrasi sensor level pakan.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nilai Terbaca: <span class="fw-bold" id="read-value-feed">22.0 cm</span></label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">Offset (cm)</span>
                                        <input type="number" class="form-control" id="offset-feed" step="0.1" placeholder="0.0">
                                        <button class="btn btn-outline-primary" onclick="setOffsetCalibration('feed', this)">
                                            <i class="bi bi-check-lg"></i> Terapkan
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="auto-calibration">
                                    <h6><i class="bi bi-robot"></i> Auto Kalibrasi</h6>
                                    <p class="text-muted small">Masukkan nilai referensi aktual untuk kalibrasi otomatis.</p>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">Nilai Referensi</span>
                                        <input type="number" class="form-control" id="reference-feed" step="0.1" value="25.0">
                                        <button class="btn btn-success" onclick="autoCalibrate('feed')">
                                            <i class="bi bi-gear"></i> Auto Kalibrasi
                                        </button>
                                    </div>
                                    <small class="text-muted">Isi pakan ke level tertentu (misal 25 cm) sebagai referensi.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-4">
                    <!-- System Settings -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-gear"></i> Pengaturan Sistem</h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Interval Pengiriman Data (detik)</label>
                                <input type="number" class="form-control" id="data-interval" value="5" min="1" max="60">
                                <div class="form-text">Interval pengiriman data ke server</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Threshold Peringatan Level Air Rendah (cm)</label>
                                <input type="number" class="form-control" id="warning-water-low" value="15" step="0.1">
                                <div class="form-text">Peringatan akan muncul jika level air di bawah nilai ini</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Threshold Peringatan Level Air Tinggi (cm)</label>
                                <input type="number" class="form-control" id="warning-water-high" value="55" step="0.1">
                                <div class="form-text">Peringatan akan muncul jika level air di atas nilai ini</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Threshold Peringatan Level Pakan (cm)</label>
                                <input type="number" class="form-control" id="warning-feed" value="5" step="0.1">
                                <div class="form-text">Peringatan akan muncul jika level pakan di bawah nilai ini</div>
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-primary" onclick="confirmSaveSettings()" id="btn-save-settings">
                                    <i class="bi bi-save"></i> Simpan Pengaturan
                                </button>
                                <button class="btn btn-outline-danger" onclick="confirmResetCalibration()" id="btn-reset-calibration">
                                    <i class="bi bi-arrow-clockwise"></i> Reset Semua Kalibrasi
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Last Calibration History -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="bi bi-clock-history"></i> Riwayat Kalibrasi Terakhir</h4>
                        </div>
                        <div class="card-body">
                            <div id="calibration-history-container">
                                <div class="text-center text-muted py-4" id="empty-history">
                                    <i class="bi bi-clock-history display-4 mb-3"></i>
                                    <p>Belum ada riwayat kalibrasi</p>
                                </div>
                                
                                <div id="history-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification" id="notification-container"></div>

    <script>
        // ============================================
        // KONFIGURASI AWAL
        // ============================================
        
        // MQTT Connection
        const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

        // Variabel untuk Monitoring
        let currentFeedAmount = 50;
        let currentMode = 'auto';
        let isServoActive = false;
        let feedingInterval = null;
        let feedingDuration = 0;
        let feedingStartTime = null;
        
        // Variabel untuk kontrol debounce
        let lastControlTime = {};
        
        // Variabel untuk ESP32 Status
        let espOnline = false;
        let lastHeartbeatTime = 0;
        const HEARTBEAT_TIMEOUT = 10000; // 10 detik timeout
        
        // Variabel untuk Kalibrasi
        let lastCalibrationData = JSON.parse(localStorage.getItem('lastCalibrationData')) || {
            air: null,
            ph: null,
            tds: null,
            turbidity: null,
            feed: null
        };
        
        // Data sensor saat ini
        let currentSensorValues = {
            air: 35.0,
            ph: 7.2,
            tds: 850,
            turbidity: 12.5,
            feed: 22.0
        };

        // Mapping sensor type ke nama dan unit
        const sensorInfo = {
            air: { name: 'Level Air', unit: 'cm' },
            ph: { name: 'pH Meter', unit: 'pH' },
            tds: { name: 'TDS Sensor', unit: 'ppm' },
            turbidity: { name: 'Sensor Kekeruhan', unit: 'NTU' },
            feed: { name: 'Level Pakan', unit: 'cm' }
        };

        // Mapping topic MQTT untuk offset
        const offsetTopics = {
            air: 'akuaponik/kalibrasi/offset_air',
            ph: 'akuaponik/kalibrasi/offset_ph',
            tds: 'akuaponik/kalibrasi/offset_tds',
            turbidity: 'akuaponik/kalibrasi/offset_turbidity',
            feed: 'akuaponik/kalibrasi/offset_pakan'
        };

        // ============================================
        // FUNGSI NAVIGASI
        // ============================================

        function switchTab(tabName) {
            // Update tab buttons
            document.getElementById('monitoring-tab').classList.remove('active');
            document.getElementById('calibration-tab').classList.remove('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Show selected section
            document.getElementById('monitoring-section').classList.remove('active');
            document.getElementById('calibration-section').classList.remove('active');
            document.getElementById(tabName + '-section').classList.add('active');
        }

        // ============================================
        // FUNGSI ESP32 STATUS MANAGEMENT
        // ============================================

        // Fungsi untuk update status ESP32
        function updateESPStatus(online) {
            espOnline = online;
            const now = Date.now();
            
            // Update untuk mobile
            const statusCard = document.getElementById('esp-status-card');
            const statusIndicator = document.getElementById('esp-status-indicator');
            const statusTitle = document.getElementById('esp-status-title');
            const statusDetail = document.getElementById('esp-status-detail');
            const statusBadge = document.getElementById('esp-status-badge-text');
            
            // Update untuk desktop
            const statusCardDesktop = document.getElementById('esp-status-card-desktop');
            const statusIndicatorDesktop = document.getElementById('esp-status-indicator-desktop');
            const statusTitleDesktop = document.getElementById('esp-status-title-desktop');
            const statusDetailDesktop = document.getElementById('esp-status-detail-desktop');
            const statusBadgeDesktop = document.getElementById('esp-status-badge-text-desktop');
            
            const overlay = document.getElementById('esp-offline-overlay');
            
            if (online) {
                lastHeartbeatTime = now;
                
                // Update tampilan - ONLINE (Mobile)
                if (statusCard) {
                    statusCard.classList.remove('offline');
                    statusCard.classList.add('online');
                }
                if (statusIndicator) {
                    statusIndicator.classList.remove('offline');
                    statusIndicator.classList.add('online');
                    statusIndicator.innerHTML = '<i class="bi bi-wifi"></i>';
                }
                if (statusTitle) statusTitle.textContent = 'Status Sistem';
                if (statusDetail) statusDetail.textContent = 'Terhubung ke ESP32 & Server';
                if (statusBadge) {
                    statusBadge.textContent = 'ONLINE';
                    statusBadge.className = 'badge bg-success';
                }
                
                // Update tampilan - ONLINE (Desktop)
                if (statusCardDesktop) {
                    statusCardDesktop.classList.remove('offline');
                    statusCardDesktop.classList.add('online');
                }
                if (statusIndicatorDesktop) {
                    statusIndicatorDesktop.classList.remove('offline');
                    statusIndicatorDesktop.classList.add('online');
                    statusIndicatorDesktop.innerHTML = '<i class="bi bi-wifi"></i>';
                }
                if (statusTitleDesktop) statusTitleDesktop.textContent = 'Status Sistem';
                if (statusDetailDesktop) statusDetailDesktop.textContent = 'Terhubung ke ESP32 & Server';
                if (statusBadgeDesktop) {
                    statusBadgeDesktop.textContent = 'ONLINE';
                    statusBadgeDesktop.className = 'badge bg-success';
                }
                
                // Update mode indicator
                const modeIndicator = document.getElementById('mode-indicator');
                const modeIndicatorDesktop = document.getElementById('mode-indicator-desktop');
                if (modeIndicator) {
                    modeIndicator.innerHTML = '<i class="bi bi-robot"></i> MODE OTOMATIS';
                    modeIndicator.className = 'mode-indicator mode-auto';
                }
                if (modeIndicatorDesktop) {
                    modeIndicatorDesktop.innerHTML = '<i class="bi bi-robot"></i> MODE OTOMATIS';
                    modeIndicatorDesktop.className = 'mode-indicator mode-auto';
                }
                
                // Sembunyikan overlay
                if (overlay) overlay.classList.remove('active');
                
                // Enable kontrol berdasarkan mode
                updateControlState();
                
            } else {
                // Update tampilan - OFFLINE (Mobile)
                if (statusCard) {
                    statusCard.classList.remove('online');
                    statusCard.classList.add('offline');
                }
                if (statusIndicator) {
                    statusIndicator.classList.remove('online');
                    statusIndicator.classList.add('offline');
                    statusIndicator.innerHTML = '<i class="bi bi-wifi-off"></i>';
                }
                if (statusTitle) statusTitle.textContent = 'Status Sistem';
                if (statusDetail) statusDetail.textContent = 'ESP32 tidak terdeteksi';
                if (statusBadge) {
                    statusBadge.textContent = 'OFFLINE';
                    statusBadge.className = 'badge bg-danger';
                }
                
                // Update tampilan - OFFLINE (Desktop)
                if (statusCardDesktop) {
                    statusCardDesktop.classList.remove('online');
                    statusCardDesktop.classList.add('offline');
                }
                if (statusIndicatorDesktop) {
                    statusIndicatorDesktop.classList.remove('online');
                    statusIndicatorDesktop.classList.add('offline');
                    statusIndicatorDesktop.innerHTML = '<i class="bi bi-wifi-off"></i>';
                }
                if (statusTitleDesktop) statusTitleDesktop.textContent = 'Status Sistem';
                if (statusDetailDesktop) statusDetailDesktop.textContent = 'ESP32 tidak terdeteksi';
                if (statusBadgeDesktop) {
                    statusBadgeDesktop.textContent = 'OFFLINE';
                    statusBadgeDesktop.className = 'badge bg-danger';
                }
                
                // Tampilkan overlay
                if (overlay) overlay.classList.add('active');
                
                // DISABLE SEMUA KONTROL
                disableAllControls();
            }
        }

        // Fungsi untuk disable semua kontrol saat ESP32 offline
        function disableAllControls() {
            // Semua tombol kontrol
            const controlButtons = [
                'btn-pompa-isi-on', 'btn-pompa-isi-off',
                'btn-pompa-buang-on', 'btn-pompa-buang-off',
                'btn-irigasi-on', 'btn-irigasi-off',
                'feed-now-btn',
                'btn-mode-auto', 'btn-mode-manual'
            ];
            
            controlButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                    button.title = 'ESP32 offline';
                }
            });
            
            // Slider
            const slider = document.getElementById('feed-amount-slider');
            if (slider) {
                slider.disabled = true;
                slider.style.opacity = '0.5';
            }
            
            // Tombol kalibrasi
            const calButtons = document.querySelectorAll('[onclick*="setOffsetCalibration"], [onclick*="autoCalibrate"]');
            calButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.title = 'ESP32 offline';
            });
            
            // Tombol pengaturan
            const settingButtons = ['btn-save-settings', 'btn-reset-calibration'];
            settingButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                }
            });
        }

        // Fungsi untuk update kontrol berdasarkan status ESP dan mode
        function updateControlState() {
            if (!espOnline) {
                disableAllControls();
                return;
            }
            
            // ESP online, perbarui berdasarkan mode
            if (currentMode === 'manual') {
                enableManualControls();
            } else {
                disableManualControls();
            }
            
            // Selalu enable tombol mode jika ESP online
            enableModeButtons();
            enableCalibrationButtons();
        }

        // Fungsi untuk enable manual controls
        function enableManualControls() {
            const manualButtons = [
                'btn-pompa-isi-on', 'btn-pompa-isi-off',
                'btn-pompa-buang-on', 'btn-pompa-buang-off',
                'btn-irigasi-on', 'btn-irigasi-off',
                'feed-now-btn'
            ];
            
            manualButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.title = '';
                }
            });
            
            const slider = document.getElementById('feed-amount-slider');
            if (slider) {
                slider.disabled = false;
                slider.style.opacity = '1';
            }
        }

        // Fungsi untuk disable manual controls (hanya manual, bukan mode)
        function disableManualControls() {
            const manualButtons = [
                'btn-pompa-isi-on', 'btn-pompa-isi-off',
                'btn-pompa-buang-on', 'btn-pompa-buang-off',
                'btn-irigasi-on', 'btn-irigasi-off',
                'feed-now-btn'
            ];
            
            manualButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                    button.title = 'Mode otomatis aktif';
                }
            });
            
            const slider = document.getElementById('feed-amount-slider');
            if (slider) {
                slider.disabled = true;
                slider.style.opacity = '0.5';
            }
        }

        // Fungsi untuk enable mode buttons
        function enableModeButtons() {
            const modeButtons = ['btn-mode-auto', 'btn-mode-manual'];
            modeButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.title = '';
                }
            });
        }

        // Fungsi untuk enable calibration buttons
        function enableCalibrationButtons() {
            const calButtons = document.querySelectorAll('[onclick*="setOffsetCalibration"], [onclick*="autoCalibrate"]');
            calButtons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.title = '';
            });
            
            const settingButtons = ['btn-save-settings', 'btn-reset-calibration'];
            settingButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                }
            });
        }

        // Heartbeat checker
        function startHeartbeatChecker() {
            setInterval(() => {
                const now = Date.now();
                if (lastHeartbeatTime > 0 && (now - lastHeartbeatTime) > HEARTBEAT_TIMEOUT) {
                    if (espOnline) {
                        console.log('Heartbeat timeout - ESP32 dianggap offline');
                        updateESPStatus(false);
                        showNotification('ESP32 terputus - Sistem offline', 'danger');
                    }
                }
            }, 1000);
        }

        // ============================================
        // FUNGSI MONITORING
        // ============================================

        // Generate fish in water tank
        function generateWaterAnimations() {
            const tank = document.querySelector('.water-tank');
            if (!tank) return;
            
            // Clear existing fish
            tank.querySelectorAll('.fish').forEach(fish => fish.remove());
            
            // Add fish
            for (let i = 0; i < 3; i++) {
                const fish = document.createElement('div');
                fish.className = 'fish';
                fish.style.bottom = `${20 + i * 30}%`;
                fish.style.left = `${10 + i * 20}%`;
                fish.style.animationDelay = `${i * 2}s`;
                tank.appendChild(fish);
            }
            
            // Add bubbles
            setInterval(() => {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                const bubbleSize = 5 + Math.random() * 10;
                bubble.style.width = `${bubbleSize}px`;
                bubble.style.height = `${bubbleSize}px`;
                bubble.style.left = `${30 + Math.random() * 40}%`;
                bubble.style.bottom = '0';
                bubble.style.animationDuration = `${2 + Math.random() * 3}s`;
                tank.appendChild(bubble);
                
                // Remove bubble after animation
                setTimeout(() => bubble.remove(), 4000);
            }, 500);
        }

        // Update time
        function updateTime() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = 
                    now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
        }

        // Update water condition indicator
        function updateWaterCondition() {
            const phElement = document.getElementById('ph-value');
            const tdsElement = document.getElementById('tds-value');
            const turbidityElement = document.getElementById('turbidity-value');
            
            if (!phElement || !tdsElement || !turbidityElement) return;
            
            const ph = parseFloat(phElement.textContent);
            const tds = parseFloat(tdsElement.textContent);
            const turbidity = parseFloat(turbidityElement.textContent);
            
            let condition = "Baik";
            let indicatorClass = "good";
            
            if (ph < 6 || ph > 8 || tds > 2000 || turbidity > 50) {
                condition = "Perhatian";
                indicatorClass = "warning";
            }
            if (ph < 5 || ph > 9 || tds > 3000 || turbidity > 100) {
                condition = "Bahaya";
                indicatorClass = "danger";
            }
            
            const waterConditionElement = document.getElementById('water-condition');
            if (waterConditionElement) {
                waterConditionElement.textContent = condition;
            }
            
            const indicator = document.querySelector('.quality-indicator');
            if (indicator) {
                indicator.className = `quality-indicator ${indicatorClass}`;
            }
        }

        // Update control status indicator dari ESP32
        function updateControlStatusFromESP32(device, isOn) {
            let elementId = '';
            if (device === 'PompaIsi') elementId = 'pompa-isi-status-indicator';
            else if (device === 'PompaBuang') elementId = 'pompa-buang-status-indicator';
            else if (device === 'Irigasi') elementId = 'irigasi-status-indicator';
            else if (device === 'Servo') elementId = 'servo-status-indicator';
            else if (device === 'Manual') {
                if (isOn) {
                    updateModeIndicator(false);
                    currentMode = 'manual';
                    if (espOnline) {
                        enableManualControls();
                    }
                }
                return;
            } else if (device === 'Otomatis') {
                if (isOn) {
                    updateModeIndicator(true);
                    currentMode = 'auto';
                    if (espOnline) {
                        disableManualControls();
                    }
                }
                return;
            }
            
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.className = `control-status ${isOn ? 'status-on' : 'status-off'}`;
                    element.style.background = isOn ? '#4caf50' : '#f44336';
                    element.style.animation = isOn ? 'statusPulse 2s infinite' : 'none';
                }
            }
        }

        // Update mode indicator
        function updateModeIndicator(isAuto) {
            const modeIndicator = document.getElementById('mode-indicator');
            const modeIndicatorDesktop = document.getElementById('mode-indicator-desktop');
            currentMode = isAuto ? 'auto' : 'manual';
            
            if (isAuto) {
                if (modeIndicator) {
                    modeIndicator.innerHTML = '<i class="bi bi-robot"></i> MODE OTOMATIS';
                    modeIndicator.className = 'mode-indicator mode-auto';
                }
                if (modeIndicatorDesktop) {
                    modeIndicatorDesktop.innerHTML = '<i class="bi bi-robot"></i> MODE OTOMATIS';
                    modeIndicatorDesktop.className = 'mode-indicator mode-auto';
                }
            } else {
                if (modeIndicator) {
                    modeIndicator.innerHTML = '<i class="bi bi-hand-index"></i> MODE MANUAL';
                    modeIndicator.className = 'mode-indicator mode-manual';
                }
                if (modeIndicatorDesktop) {
                    modeIndicatorDesktop.innerHTML = '<i class="bi bi-hand-index"></i> MODE MANUAL';
                    modeIndicatorDesktop.className = 'mode-indicator mode-manual';
                }
            }
        }

        // Update slider labels
        function updateSliderLabels(percentage) {
            // Reset all labels
            document.querySelectorAll('.slider-label').forEach(label => {
                label.classList.remove('active');
            });
            
            // Activate appropriate label
            if (percentage <= 33) {
                const label = document.getElementById('label-sedikit');
                if (label) label.classList.add('active');
            } else if (percentage <= 66) {
                const label = document.getElementById('label-sedang');
                if (label) label.classList.add('active');
            } else {
                const label = document.getElementById('label-banyak');
                if (label) label.classList.add('active');
            }
        }

        // Show servo active indicator
        function showServoActiveIndicator(duration) {
            if (isServoActive) return;
            
            isServoActive = true;
            feedingDuration = duration;
            feedingStartTime = new Date();
            
            const indicator = document.getElementById('servo-active-indicator');
            const feedCard = document.getElementById('feed-control-card');
            
            // Show indicator
            if (indicator) {
                indicator.style.display = 'block';
            }
            if (feedCard) {
                feedCard.classList.add('feeding-active');
            }
            
            // Update time display
            const feedingTimeElement = document.getElementById('feeding-time');
            if (feedingTimeElement) {
                feedingTimeElement.textContent = `${duration.toFixed(1)}s`;
            }
            
            // Start progress animation
            const progressCircle = document.getElementById('servo-progress-circle');
            const circumference = 314;
            let progress = 0;
            
            // Generate particles
            generateFeedingParticles();
            
            // Start progress update
            if (feedingInterval) clearInterval(feedingInterval);
            
            feedingInterval = setInterval(() => {
                const now = new Date();
                const elapsed = (now - feedingStartTime) / 1000;
                const remaining = Math.max(0, feedingDuration - elapsed);
                progress = Math.min(100, (elapsed / feedingDuration) * 100);
                
                // Update progress ring
                if (progressCircle) {
                    const offset = circumference - (progress / 100) * circumference;
                    progressCircle.style.strokeDashoffset = offset;
                }
                
                // Update time display
                if (feedingTimeElement) {
                    feedingTimeElement.textContent = `${remaining.toFixed(1)}s`;
                }
                
                // Check if finished
                if (remaining <= 0) {
                    hideServoActiveIndicator();
                }
            }, 50);
            
            // Auto hide after duration
            setTimeout(() => {
                hideServoActiveIndicator();
            }, feedingDuration * 1000 + 500);
        }

        // Generate feeding particles
        function generateFeedingParticles() {
            const container = document.getElementById('feeding-particles');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'feeding-particle';
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`);
                    particle.style.animationDelay = `${Math.random() * 0.5}s`;
                    container.appendChild(particle);
                    
                    // Remove particle after animation
                    setTimeout(() => {
                        if (particle.parentNode === container) {
                            particle.remove();
                        }
                    }, 3000);
                }, i * 150);
            }
        }

        // Hide servo active indicator
        function hideServoActiveIndicator() {
            if (!isServoActive) return;
            
            isServoActive = false;
            const indicator = document.getElementById('servo-active-indicator');
            const feedCard = document.getElementById('feed-control-card');
            
            if (indicator) {
                // Add disappear animation
                indicator.style.animation = 'servoIndicatorDisappear 0.5s ease-out forwards';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                    indicator.style.animation = 'servoIndicatorAppear 0.5s ease-out forwards';
                }, 500);
            }
            
            if (feedCard) {
                feedCard.classList.remove('feeding-active');
            }
            
            if (feedingInterval) {
                clearInterval(feedingInterval);
                feedingInterval = null;
            }
        }

        // Show feeding animation in feed container
        function showFeedAnimation() {
            const animationContainer = document.getElementById('feed-animation');
            if (!animationContainer) return;
            
            animationContainer.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'feed-particle';
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 50}%`;
                    animationContainer.appendChild(particle);
                    
                    setTimeout(() => {
                        if (particle.parentNode === animationContainer) {
                            particle.remove();
                        }
                    }, 1000);
                }, i * 100);
            }
        }

        // Check feed level and show alert if low
        function checkFeedLevel(level, max = 29) {
            const percent = (level / max) * 100;
            const alertElement = document.getElementById('feed-alert');
            
            if (alertElement) {
                if (percent < 20) {
                    alertElement.style.display = 'block';
                    alertElement.classList.add('animate__animated', 'animate__headShake');
                } else {
                    alertElement.style.display = 'none';
                }
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show shadow-lg mb-2`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="this.parentElement.remove()"></button>
            `;
            
            const container = document.getElementById('notification-container');
            if (container) {
                container.appendChild(notification);
                
                // Hapus setelah 5 detik
                setTimeout(() => {
                    if (notification.parentNode === container) {
                        notification.remove();
                    }
                }, 5000);
            }
        }

        // Feed duration mapping ke kode
        function getFeedCodeFromPercentage(percentage) {
            if (percentage <= 33) return "1";      // Pendek (0.5s)
            if (percentage <= 66) return "2";      // Sedang (1.5s)
            return "3";                            // Panjang (3.0s)
        }

        // Feed now function
        function feedNow() {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat memberi pakan', 'danger');
                return;
            }
            
            if (currentMode === 'auto') {
                showNotification('Tidak bisa memberi pakan manual saat mode otomatis aktif!', 'warning');
                return;
            }
            
            if (isServoActive) {
                showNotification('Servo pakan masih aktif. Tunggu sampai selesai.', 'warning');
                return;
            }
            
            // DEBOUNCE: Cegah klik terlalu cepat
            const now = Date.now();
            if (lastControlTime['servo'] && now - lastControlTime['servo'] < 1000) {
                showNotification('Tunggu sebentar sebelum memberi pakan lagi', 'warning');
                return;
            }
            lastControlTime['servo'] = now;
            
            const feedCode = getFeedCodeFromPercentage(currentFeedAmount);
            
            // Disable tombol sementara
            const feedBtn = document.getElementById('feed-now-btn');
            if (feedBtn) {
                feedBtn.disabled = true;
                feedBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';
            }
            
            // Tampilkan loading
            showControlLoading('servo', true);
            
            // Kirim perintah
            client.publish('akuaponik/kendali/servo', '1');
            client.publish('akuaponik/pakan/durasi', feedCode);
            
            // Tampilkan animasi
            showFeedAnimation();
            
            showNotification(`Mengirim perintah pakan (kode: ${feedCode})`, 'info');
            
            // Auto enable tombol setelah 2 detik
            setTimeout(() => {
                if (feedBtn) {
                    feedBtn.disabled = false;
                    feedBtn.innerHTML = '<i class="bi bi-bucket-fill"></i> BERI PAKAN';
                }
                showControlLoading('servo', false);
            }, 2000);
        }

        // Update water visual
        function updateWaterVisual(current, max) {
            const percent = (current / max) * 100;
            const waterLevel = document.getElementById('water-level-visual');
            if (waterLevel) {
                waterLevel.style.height = `${Math.min(percent, 100)}%`;
            }
            
            const waterLevelText = document.getElementById('water-level');
            if (waterLevelText) {
                waterLevelText.textContent = current.toFixed(1);
            }
            
            // Update progress bars for sensors
            const phElement = document.getElementById('ph-value');
            const tdsElement = document.getElementById('tds-value');
            const turbidityElement = document.getElementById('turbidity-value');
            
            if (phElement && tdsElement && turbidityElement) {
                const phValue = parseFloat(phElement.textContent);
                const tdsValue = parseFloat(tdsElement.textContent);
                const turbidityValue = parseFloat(turbidityElement.textContent);
                
                const phProgress = document.getElementById('ph-progress');
                const tdsProgress = document.getElementById('tds-progress');
                const turbidityProgress = document.getElementById('turbidity-progress');
                
                if (phProgress) phProgress.style.width = `${(phValue / 14) * 100}%`;
                if (tdsProgress) tdsProgress.style.width = `${Math.min(100, (tdsValue / 5000) * 100)}%`;
                if (turbidityProgress) turbidityProgress.style.width = `${Math.min(100, (turbidityValue / 1000) * 100)}%`;
            }
        }

        // Update feed visual
        function updateFeedVisual(current, max) {
            const percent = (current / max) * 100;
            const feedLevel = document.getElementById('feed-level-visual');
            if (feedLevel) {
                feedLevel.style.height = `${Math.min(percent, 100)}%`;
            }
            
            const feedLevelText = document.getElementById('feed-level');
            if (feedLevelText) {
                feedLevelText.textContent = current.toFixed(1);
            }
            
            const feedPercentage = document.getElementById('feed-percentage');
            if (feedPercentage) {
                feedPercentage.textContent = `${Math.round(percent)}%`;
            }
            
            const feedProgressBar = document.getElementById('feed-progress-bar');
            if (feedProgressBar) {
                feedProgressBar.style.width = `${percent}%`;
            }
            
            // Check if feed is low
            checkFeedLevel(current, max);
        }

        // Fungsi untuk disable/enable tombol kontrol
        function disableControlButtons(device, disable) {
            const onBtn = document.getElementById(`btn-${device}-on`);
            const offBtn = document.getElementById(`btn-${device}-off`);
            
            if (onBtn) onBtn.disabled = disable;
            if (offBtn) offBtn.disabled = disable;
            
            if (device === 'servo') {
                const feedBtn = document.getElementById('feed-now-btn');
                if (feedBtn) feedBtn.disabled = disable;
            }
            
            if (disable) {
                if (onBtn) onBtn.style.opacity = '0.6';
                if (offBtn) offBtn.style.opacity = '0.6';
            } else {
                if (onBtn) onBtn.style.opacity = '1';
                if (offBtn) offBtn.style.opacity = '1';
            }
        }

        // Fungsi untuk menampilkan loading state
        function showControlLoading(device, show) {
            const indicator = document.getElementById(`${device}-status-indicator`);
            if (!indicator) return;
            
            if (show) {
                indicator.className = 'control-status status-loading';
                indicator.style.background = '#ff9800';
                indicator.style.animation = 'pulse 1s infinite';
            }
            // Status akhir akan diupdate oleh MQTT handler dari ESP32
        }

        // Control functions
        function setMode(mode) {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mengubah mode', 'danger');
                return;
            }
            
            if (mode === 'auto') {
                client.publish('akuaponik/mode/Otomatis', '1');
                client.publish('akuaponik/mode/Manual', '0');
                
                updateModeIndicator(true);
                currentMode = 'auto';
                if (espOnline) {
                    disableManualControls();
                }
                
                showNotification('Mode diubah ke Otomatis', 'success');
                
            } else {
                client.publish('akuaponik/mode/Manual', '1');
                client.publish('akuaponik/mode/Otomatis', '0');
                
                updateModeIndicator(false);
                currentMode = 'manual';
                if (espOnline) {
                    enableManualControls();
                }
                
                showNotification('Mode diubah ke Manual', 'warning');
            }
        }

        function controlDevice(device, state) {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mengirim perintah', 'danger');
                return;
            }
            
            if (currentMode === 'auto') {
                showNotification('Tidak bisa mengontrol manual saat mode otomatis aktif!', 'warning');
                return;
            }
            
            // DEBOUNCE: Cegah klik terlalu cepat
            const now = Date.now();
            if (lastControlTime[device] && now - lastControlTime[device] < 1000) {
                showNotification(`Tunggu sebentar sebelum mengontrol ${device} lagi`, 'warning');
                return;
            }
            lastControlTime[device] = now;
            
            // Disable tombol sementara
            disableControlButtons(device, true);
            
            const value = state === 'on' ? '1' : '0';
            let topic = '';
            
            if (device === 'pompa-isi') {
                topic = 'akuaponik/kendali/PompaIsi';
            } else if (device === 'pompa-buang') {
                topic = 'akuaponik/kendali/PompaBuang';
            } else if (device === 'irigasi') {
                topic = 'akuaponik/kendali/Irigasi';
            } else {
                topic = 'akuaponik/kendali/servo';
            }
            
            // TAMPILKAN LOADING STATE
            showControlLoading(device, true);
            
            // Kirim perintah
            client.publish(topic, value);
            
            const deviceNames = {
                'pompa-isi': 'Pompa Isi Air',
                'pompa-buang': 'Pompa Buang Air',
                'irigasi': 'Sistem Irigasi',
                'servo': 'Servo Pakan'
            };
            
            showNotification(`Mengirim perintah: ${deviceNames[device]} ${state === 'on' ? 'ON' : 'OFF'}`, 'info');
            
            // Auto enable tombol setelah 2 detik
            setTimeout(() => {
                disableControlButtons(device, false);
                showControlLoading(device, false);
            }, 2000);
        }

        // ============================================
        // FUNGSI KALIBRASI
        // ============================================

        // Fungsi untuk set offset kalibrasi
        function setOffsetCalibration(type, buttonElement) {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mengkalibrasi', 'danger');
                return;
            }
            
            const inputId = `offset-${type}`;
            const input = document.getElementById(inputId);
            const offsetValue = input.value.trim();
            
            // Validasi input
            if (!offsetValue) {
                showNotification('Masukkan nilai offset terlebih dahulu', 'warning');
                return;
            }
            
            const offset = parseFloat(offsetValue);
            if (isNaN(offset)) {
                showNotification('Nilai offset harus berupa angka', 'warning');
                return;
            }
            
            // Simpan button state asli
            const originalText = buttonElement.innerHTML;
            const originalClass = buttonElement.className;
            
            // Tampilkan loading
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';
            
            // Kirim MQTT
            setTimeout(() => {
                try {
                    const topic = offsetTopics[type];
                    if (!topic) {
                        throw new Error(`Topik untuk sensor ${type} tidak ditemukan`);
                    }
                    
                    client.publish(topic, offset.toString());
                    console.log(`Mengirim offset ${type}: ${offset} ke ${topic}`);
                    
                    lastCalibrationData[type] = {
                        sensor: sensorInfo[type].name,
                        offset: offset,
                        oldValue: currentSensorValues[type],
                        unit: sensorInfo[type].unit,
                        date: new Date().toLocaleString('id-ID')
                    };
                    
                    localStorage.setItem('lastCalibrationData', JSON.stringify(lastCalibrationData));
                    
                    updateCalibrationHistoryDisplay();
                    
                    input.value = '';
                    
                    showNotification(`Offset ${sensorInfo[type].name} diatur ke ${offset} ${sensorInfo[type].unit}`, 'success');
                    
                    buttonElement.innerHTML = '<i class="bi bi-check2-all me-2"></i>Berhasil';
                    buttonElement.className = 'btn btn-success';
                    
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.className = originalClass;
                        buttonElement.disabled = false;
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error setting offset:', error);
                    
                    buttonElement.innerHTML = '<i class="bi bi-x-circle me-2"></i>Gagal';
                    buttonElement.className = 'btn btn-outline-danger';
                    
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.className = originalClass;
                        buttonElement.disabled = false;
                    }, 2000);
                    
                    showNotification(`Gagal menyimpan offset: ${error.message}`, 'danger');
                }
            }, 1000);
        }

        // Fungsi auto kalibrasi
        function autoCalibrate(type) {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mengkalibrasi', 'danger');
                return;
            }
            
            const referenceInput = document.getElementById(`reference-${type}`);
            const referenceValue = parseFloat(referenceInput.value);
            
            if (isNaN(referenceValue)) {
                showNotification('Masukkan nilai referensi yang valid', 'warning');
                return;
            }
            
            const currentValue = currentSensorValues[type];
            const offset = (referenceValue - currentValue).toFixed(type === 'ph' ? 2 : 1);
            
            const offsetInput = document.getElementById(`offset-${type}`);
            offsetInput.value = offset;
            
            offsetInput.style.borderColor = '#28a745';
            offsetInput.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
            setTimeout(() => {
                offsetInput.style.borderColor = '';
                offsetInput.style.boxShadow = '';
            }, 2000);
            
            showNotification(
                `Auto-kalibrasi: Referensi ${referenceValue}${sensorInfo[type].unit} - Terbaca ${currentValue.toFixed(2)}${sensorInfo[type].unit} = Offset ${offset}${sensorInfo[type].unit}`,
                'info'
            );
        }

        // Update tampilan riwayat kalibrasi
        function updateCalibrationHistoryDisplay() {
            const historyList = document.getElementById('history-list');
            const emptyHistory = document.getElementById('empty-history');
            
            if (!historyList || !emptyHistory) return;
            
            historyList.innerHTML = '';
            
            const hasHistory = Object.values(lastCalibrationData).some(entry => entry !== null);
            
            if (!hasHistory) {
                emptyHistory.style.display = 'block';
                return;
            }
            
            emptyHistory.style.display = 'none';
            
            Object.entries(lastCalibrationData).forEach(([type, entry]) => {
                if (entry) {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">${entry.sensor}</h6>
                            <small class="text-muted">${entry.date}</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Nilai Sebelum</small>
                                <div>${entry.oldValue} ${entry.unit}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Offset</small>
                                <div class="text-primary fw-bold">${entry.offset} ${entry.unit}</div>
                            </div>
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                }
            });
        }

        // Reset semua kalibrasi
        function resetCalibration() {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mereset kalibrasi', 'danger');
                return;
            }
            
            try {
                client.publish('akuaponik/kalibrasi/offset_air', '0');
                client.publish('akuaponik/kalibrasi/offset_ph', '0');
                client.publish('akuaponik/kalibrasi/offset_tds', '0');
                client.publish('akuaponik/kalibrasi/offset_turbidity', '0');
                client.publish('akuaponik/kalibrasi/offset_pakan', '0');
                
                lastCalibrationData = {
                    air: null,
                    ph: null,
                    tds: null,
                    turbidity: null,
                    feed: null
                };
                
                localStorage.setItem('lastCalibrationData', JSON.stringify(lastCalibrationData));
                
                const offsetInputs = ['air', 'ph', 'tds', 'turbidity', 'feed'];
                offsetInputs.forEach(type => {
                    const input = document.getElementById(`offset-${type}`);
                    if (input) input.value = '0';
                });
                
                document.getElementById('reference-air').value = '35.0';
                document.getElementById('reference-ph').value = '7.00';
                document.getElementById('reference-tds').value = '1000';
                document.getElementById('reference-turbidity').value = '0.0';
                document.getElementById('reference-feed').value = '25.0';
                
                updateCalibrationHistoryDisplay();
                
                showNotification('Semua kalibrasi telah direset ke nilai default (0)', 'warning');
                
            } catch (error) {
                console.error('Error resetting calibration:', error);
                showNotification('Gagal mereset kalibrasi: ' + error.message, 'danger');
            }
        }

        // ============================================
        // FUNGSI MODAL KONFIRMASI
        // ============================================

        let currentAction = null;

        function showConfirmModal(title, message, action) {
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmModal = document.getElementById('confirm-modal');
            
            if (confirmTitle) confirmTitle.textContent = title;
            if (confirmMessage) confirmMessage.textContent = message;
            currentAction = action;
            
            if (confirmModal) confirmModal.style.display = 'flex';
        }

        function hideConfirmModal() {
            const confirmModal = document.getElementById('confirm-modal');
            if (confirmModal) confirmModal.style.display = 'none';
            currentAction = null;
        }

        function confirmAction() {
            if (currentAction) {
                currentAction();
            }
            hideConfirmModal();
        }

        // Konfirmasi simpan pengaturan
        function confirmSaveSettings() {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat menyimpan pengaturan', 'danger');
                return;
            }
            
            showConfirmModal(
                'Simpan Pengaturan',
                'Apakah Anda yakin ingin menyimpan semua pengaturan sistem?',
                saveSettings
            );
        }

        // Konfirmasi reset kalibrasi
        function confirmResetCalibration() {
            if (!espOnline) {
                showNotification('ESP32 offline - Tidak dapat mereset kalibrasi', 'danger');
                return;
            }
            
            showConfirmModal(
                'Reset Kalibrasi',
                'PERINGATAN: Semua offset kalibrasi akan dikembalikan ke nilai default (0). Tindakan ini tidak dapat dibatalkan.',
                resetCalibration
            );
        }

        // Simpan pengaturan sistem
        function saveSettings() {
            try {
                const intervalInput = document.getElementById('data-interval');
                const warningWaterLowInput = document.getElementById('warning-water-low');
                const warningWaterHighInput = document.getElementById('warning-water-high');
                const warningFeedInput = document.getElementById('warning-feed');
                
                if (!intervalInput || !warningWaterLowInput || !warningWaterHighInput || !warningFeedInput) {
                    showNotification('Elemen pengaturan tidak ditemukan', 'danger');
                    return;
                }
                
                const settings = {
                    interval: intervalInput.value,
                    warningWaterLow: warningWaterLowInput.value,
                    warningWaterHigh: warningWaterHighInput.value,
                    warningFeed: warningFeedInput.value
                };
                
                if (parseFloat(settings.warningWaterLow) >= parseFloat(settings.warningWaterHigh)) {
                    showNotification('Threshold level air rendah harus lebih kecil dari threshold tinggi', 'warning');
                    return;
                }
                
                client.publish('akuaponik/pengaturan/interval', settings.interval);
                client.publish('akuaponik/pengaturan/warning_water_low', settings.warningWaterLow);
                client.publish('akuaponik/pengaturan/warning_water_high', settings.warningWaterHigh);
                client.publish('akuaponik/pengaturan/warning_feed', settings.warningFeed);
                
                showNotification('Pengaturan sistem berhasil disimpan', 'success');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Gagal menyimpan pengaturan', 'danger');
            }
        }

        // ============================================
        // INISIALISASI
        // ============================================

        // Event listeners untuk modal
        document.addEventListener('DOMContentLoaded', function() {
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const confirmModal = document.getElementById('confirm-modal');
            
            if (confirmActionBtn) {
                confirmActionBtn.addEventListener('click', confirmAction);
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideConfirmModal);
            }
            if (confirmModal) {
                confirmModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideConfirmModal();
                    }
                });
            }
            
            // Inisialisasi fungsi lainnya
            updateTime();
            setInterval(updateTime, 1000);
            
            document.querySelectorAll('input[id^="offset-"]').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const type = this.id.replace('offset-', '');
                        const button = this.parentElement.querySelector('button');
                        if (button) {
                            setOffsetCalibration(type, button);
                        }
                    }
                });
            });
            
            updateCalibrationHistoryDisplay();
            generateWaterAnimations();
            
            // Set initial values for monitoring
            const phValue = document.getElementById('ph-value');
            const tdsValue = document.getElementById('tds-value');
            const turbidityValue = document.getElementById('turbidity-value');
            const waterLevel = document.getElementById('water-level');
            const feedLevel = document.getElementById('feed-level');
            
            if (phValue) phValue.textContent = '7.2';
            if (tdsValue) tdsValue.textContent = '850';
            if (turbidityValue) turbidityValue.textContent = '12';
            if (waterLevel) waterLevel.textContent = '35.0';
            if (feedLevel) feedLevel.textContent = '22.0';
            
            // Initialize visualizations
            updateWaterVisual(35, 63);
            updateFeedVisual(22, 29);
            updateWaterCondition();
            
            // Set slider to initial value
            const slider = document.getElementById('feed-amount-slider');
            if (slider) {
                slider.value = currentFeedAmount;
                updateSliderLabels(currentFeedAmount);
            }
            
            // Set initial control status
            updateControlStatusFromESP32('PompaIsi', false);
            updateControlStatusFromESP32('PompaBuang', false);
            updateControlStatusFromESP32('Irigasi', false);
            updateControlStatusFromESP32('Servo', false);
            
            // Set initial mode
            updateModeIndicator(true);
            updateESPStatus(false); // Mulai dengan status offline
            
            // Start heartbeat checker
            startHeartbeatChecker();
        });

        // ============================================
        // MQTT HANDLING
        // ============================================

        // MQTT Connection handler
        client.on('connect', () => {
            console.log('Dashboard terhubung ke broker MQTT');
            
            // Update status
            const statusDetail = document.getElementById('esp-status-detail');
            const statusDetailDesktop = document.getElementById('esp-status-detail-desktop');
            
            if (statusDetail) {
                statusDetail.textContent = 'Terhubung ke server, menunggu ESP32...';
            }
            if (statusDetailDesktop) {
                statusDetailDesktop.textContent = 'Terhubung ke server, menunggu ESP32...';
            }
            
            const topics = [
                'akuaponik/monitoring/pH',
                'akuaponik/monitoring/TDS',
                'akuaponik/monitoring/Turbidity',
                'akuaponik/monitoring/Air',
                'akuaponik/monitoring/Pakan',
                'akuaponik/Status/Manual',
                'akuaponik/Status/Otomatis',
                'akuaponik/Status/PompaIsi',
                'akuaponik/Status/PompaBuang',
                'akuaponik/Status/Irigasi',
                'akuaponik/Status/Servo',
                'akuaponik/heartbeat',
                'akuaponik/pengaturan/+'
            ];
            
            topics.forEach(topic => {
                client.subscribe(topic, (err) => {
                    if (err) {
                        console.error(`Gagal subscribe ke ${topic}:`, err);
                    }
                });
            });
        });

        // MQTT Message handler
        client.on('message', (topic, message) => {
            const payload = message.toString();
            
            function animateValueChange(elementId, newValue) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const oldValue = parseFloat(element.textContent);
                const duration = 500;
                const steps = 30;
                const stepValue = (newValue - oldValue) / steps;
                let currentStep = 0;
                
                const interval = setInterval(() => {
                    if (currentStep >= steps) {
                        element.textContent = newValue;
                        clearInterval(interval);
                    } else {
                        const currentValue = oldValue + (stepValue * currentStep);
                        element.textContent = currentValue.toFixed(1);
                        currentStep++;
                    }
                }, duration / steps);
            }
            
            try {
                if (topic === 'akuaponik/monitoring/pH') {
                    const value = parseFloat(payload);
                    currentSensorValues.ph = value;
                    animateValueChange('ph-value', value);
                    const readValuePh = document.getElementById('read-value-ph');
                    if (readValuePh) readValuePh.textContent = `${value.toFixed(2)} pH`;
                    updateWaterCondition();
                } else if (topic === 'akuaponik/monitoring/TDS') {
                    const value = parseFloat(payload);
                    currentSensorValues.tds = value;
                    animateValueChange('tds-value', value);
                    const readValueTds = document.getElementById('read-value-tds');
                    if (readValueTds) readValueTds.textContent = `${value} ppm`;
                    updateWaterCondition();
                } else if (topic === 'akuaponik/monitoring/Turbidity') {
                    const value = parseFloat(payload);
                    currentSensorValues.turbidity = value;
                    animateValueChange('turbidity-value', value);
                    const readValueTurbidity = document.getElementById('read-value-turbidity');
                    if (readValueTurbidity) readValueTurbidity.textContent = `${value.toFixed(1)} NTU`;
                    updateWaterCondition();
                } else if (topic === 'akuaponik/monitoring/Air') {
                    const value = parseFloat(payload);
                    currentSensorValues.air = value;
                    updateWaterVisual(value, 63);
                    const readValueAir = document.getElementById('read-value-air');
                    if (readValueAir) readValueAir.textContent = `${value.toFixed(1)} cm`;
                } else if (topic === 'akuaponik/monitoring/Pakan') {
                    const value = parseFloat(payload);
                    currentSensorValues.feed = value;
                    updateFeedVisual(value, 29);
                    const readValueFeed = document.getElementById('read-value-feed');
                    if (readValueFeed) readValueFeed.textContent = `${value.toFixed(1)} cm`;
                } else if (topic.includes('Status/')) {
                    const device = topic.split('/').pop();
                    const isOn = payload === '1';
                    
                    updateControlStatusFromESP32(device, isOn);
                    
                    // Matikan loading state jika ada
                    let deviceId = '';
                    if (device === 'PompaIsi') deviceId = 'pompa-isi';
                    else if (device === 'PompaBuang') deviceId = 'pompa-buang';
                    else if (device === 'Irigasi') deviceId = 'irigasi';
                    else if (device === 'Servo') deviceId = 'servo';
                    
                    if (deviceId) {
                        showControlLoading(deviceId, false);
                        disableControlButtons(deviceId, false);
                    }
                    
                    // Handle servo aktif indicator
                    if (device === 'Servo' && isOn) {
                        const duration = currentFeedAmount <= 33 ? 0.5 : currentFeedAmount <= 66 ? 1.5 : 3.0;
                        showServoActiveIndicator(duration);
                    } else if (device === 'Servo' && !isOn) {
                        hideServoActiveIndicator();
                    }
                } else if (topic === 'akuaponik/heartbeat') {
                    const status = payload.toString();
                    if (status === 'ON') {
                        if (!espOnline) {
                            updateESPStatus(true);
                            showNotification('Sistem online - Kontrol diaktifkan', 'success');
                        }
                        // Perbarui waktu heartbeat terakhir
                        lastHeartbeatTime = Date.now();
                    } else if (status === 'OFF') {
                        if (espOnline) {
                            updateESPStatus(false);
                            showNotification('ESP32 terputus - Sistem offline', 'danger');
                        }
                    }
                }
            } catch (error) {
                console.error('Error processing MQTT message:', error);
            }
        });

        // Handle MQTT errors
        client.on('error', (error) => {
            console.error('MQTT Error:', error);
            
            // Update status karena MQTT error
            updateESPStatus(false);
        });

        // Handle MQTT disconnect
        client.on('disconnect', () => {
            console.log('Dashboard terputus dari broker MQTT');
            
            // Update status karena MQTT disconnect
            updateESPStatus(false);
        });

        // Slider event handler
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('feed-amount-slider');
            if (slider) {
                slider.addEventListener('input', function() {
                    currentFeedAmount = this.value;
                    updateSliderLabels(currentFeedAmount);
                    
                    if (espOnline) {
                        const feedCode = getFeedCodeFromPercentage(currentFeedAmount);
                        client.publish('akuaponik/pakan/durasi', feedCode);
                    }
                });
            }
        });
    </script>
</body>
</html>
